<?php

/**
 * @file
 * This is an example outlining how a module can be used to define a new
 * node type.
 *
 * (Note that custom node types are most often created with CCK in recent
 * versions of Drupal.)
 *
 * Our Boletin Grupo type will allow users to specify a "color" and a "quantity"
 * for their nodes; some kind of rudimentary inventory-tracking system, perhaps?
 * To store this extra information, we need an auxiliary database table as
 * defined in boletin_grupo_schema().
 */

/**
 * @defgroup boletin_grupo Example: Node
 * @ingroup examples
 * @{
 * Creating a new content type in a module. (drupal 6)
 *
 * This is an example outlining how a module can be used to define a new
 * node type.
 *
 * (Note that custom node types are most often created with CCK in recent
 * versions of Drupal.)
 *
 * Our Boletin Grupo type will allow users to specify a "color" and a "quantity"
 * for their nodes; some kind of rudimentary inventory-tracking system, perhaps?
 * To store this extra information, we need an auxiliary database table as
 * defined in boletin_grupo_schema().
 *
 * This example is part of the Examples for Developers Project which you can download
 * and experiment with here: http://drupal.org/project/examples
 */

/**
 * Implementation of hook_menu().
 */
function boletin_grupo_menu() {
  $items['boletin_grupo'] = array(
    'title' => 'Group Bulletin',
    'page callback' => 'boletin_grupo_list_callback',
    //'access arguments' => array('Ver boletin_grupo_list'),
    'access callback'=>'boletin_grupo_custom_access',
  );
  $items['boletin_grupo/%/my_edit'] = array(
    'title' => t('Edit Group Bulletin'),
    'page callback' => 'drupal_get_form',
    'page arguments'   => array('boletin_grupo_my_edit_form'),
    //'type' => MENU_CALLBACK,
    //'access callback' => TRUE,
    'access arguments' => array('Ver boletin_grupo_my_edit_form'),
  );
  $items['boletin_grupo/%/my_web'] = array(
    'title' => t('View Group Bulletin'),
    'page callback' => 'boletin_grupo_web_callback',
    'access arguments' => array('Ver gestion_boletin_grupo_web'),
  );
  $items['boletin_grupo/%/my_no_recibir'] = array(
    'title' => t('Subscribe/Unsubscribe to the Group Bulletin'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('boletin_grupo_my_no_recibir_form'),
    'access arguments' => array('Ver boletin_grupo_my_no_recibir'),
  );
  $items['boletin_grupo/%/my_delete'] = array(
    'title' => t('Delete Group Bulletin'),
    'page callback' => 'drupal_get_form',
    'page arguments'   => array('boletin_grupo_my_delete_form'),
    //'type' => MENU_CALLBACK,
    //'access callback' => TRUE,
    'access arguments' => array('Ver boletin_grupo_my_delete_form'),
  );
  //intelsat-2015
  $items['boletin_grupo/%/historico'] = array(
    'title' => 'Archive',
    'page callback' => 'boletin_grupo_historico_callback',
    //'access arguments' => array('Ver boletin_grupo_list'),
    'access callback'=>'boletin_grupo_custom_access',  
  );
  $items['boletin_grupo/%/my_web_historico/%'] = array(
    'title' => 'Archive',
    'page callback' => 'boletin_grupo_my_web_historico_callback',
    //'access arguments' => array('Ver boletin_grupo_list'),
    'access callback'=>'boletin_grupo_custom_access',  
  );
  $items['boletin_grupo/%/download_html/%'] = array(
    'title' => 'Archive',
    'page callback' => 'boletin_grupo_download_html_callback',
    //'access arguments' => array('Ver boletin_grupo_list'),
    'access callback'=>'boletin_grupo_custom_access',  
  );
  $items['boletin_grupo/%/forward/%'] = array(
    'title' => 'Archive',
    'page callback' => 'boletin_grupo_forward_callback',
    //'access arguments' => array('Ver boletin_grupo_list'),
    'access callback'=>'boletin_grupo_custom_access',  
  );
  $items['boletin_grupo/%/pdf/%'] = array(
    'title' => 'Archive',
    'page callback' => 'boletin_grupo_pdf_callback',
    'access callback' =>'boletin_grupo_pdf_access',
  );
  //
  return $items;
}

/**
 * Explain how the module demonstrates a new node type.boletin_grupo.test
 */
function boletin_grupo_list_callback() {
    return boletin_grupo_table();
}
/**
 * Implementation of hook_node_info().
 *
 * This is a required node hook. This function describes the nodes provided by
 * this module.
 *
 * The required attributes are:
 * - "name" provides a human readable name for the node,
 * - "module" tells Drupal how the module's functions map to hooks (i.e. if the
 *   module is boletin_grupo_foo then boletin_grupo_foo_insert will be called
 *   when inserting the node).
 * - "description" provides a brief description of the node type, which is
 *   shown when a user accesses the "Create content" page for that node type.
 *
 * The other optional, attributes:
 * - "has_title" boolean that indicates whether or not this node type has a
 *   title field.
 * - "title_label": the label for the title field of this content type.
 * - "has_body": boolean that indicates whether or not this node type has a
 *   body field.
 * - "body_label": the label for the body field of this content type.
 * - "min_word_count": the minimum number of words for the body field to be
 *   considered valid for this content type.
 *
 * The key in this example, "example_node_type_1", is the "machine name" of the
 * node type and is stored in {node}.type. The node's type value cannot be
 * changed through the admin interface.
 *
 */
function boletin_grupo_node_info() {
  return array(
    'boletin_grupo' => array(
      'name' => t('Group Bulletin - Type 1'),
      'module' => 'boletin_grupo',
      //'description' => t("An Boletin Grupo type with a few fields."),
      'description' => t("A Group Bulletin type with a few fields."),
      'has_title' => TRUE,
      'title_label' => t('Group Bulletin - Type 1 - Title'),
      'has_body' => TRUE,
      'body_label' => t('Group Bulletin - Type 1  - Body'),
    )
  );
}

/**
 * Implementation of hook_access().
 *
 * Node modules may implement node_access() to determine the operations
 * users may perform on nodes. This example uses a very common access pattern.
 */
function boletin_grupo_access($op, $node, $account) {
  if ($op == 'create') {
    return user_access('create Boletin Grupo', $account);
  }

  if ($op == 'update') {
    if (user_access('edit any Boletin Grupo', $account) || (user_access('edit own Boletin Grupo', $account) && ($account->uid == $node->uid))) {
      return TRUE;
    }
  }

  if ($op == 'delete') {
    if (user_access('delete any Boletin Grupo', $account) || (user_access('delete own Boletin Grupo', $account) && ($account->uid == $node->uid))) {
      return TRUE;
    }
  }
}

/**
 * Implementation of hook_perm().
 *
 * Since we are limiting the ability to create new nodes to certain users,
 * we need to define what those permissions are here. We also define a permission
 * to allow users to edit the nodes they created.
 */
function boletin_grupo_perm() {
  return array(
    'create Boletin Grupo',
    'delete own Boletin Grupo',
    'delete any Boletin Grupo',
    'edit own Boletin Grupo',
    'edit any Boletin Grupo',
    //gemini
    'Ver boletin_grupo_my_edit_form',
    'Ver gestion_boletin_grupo_web',
    'Ver boletin_grupo_my_no_recibir',
    'Ver boletin_grupo_my_delete_form',
  );
}

/**
 * Implementation of hook_form().
 *
 * Now it's time to describe the form for collecting the information
 * specific to this node type. This hook requires us to return an array with
 * a sub array containing information for each element in the form.
 */
function boletin_grupo_form(&$node, $form_state) {
  // The site admin can decide if this node type has a title and body, and how
  // the fields should be labeled. We need to load these settings so we can
  // build the node form correctly.
  $type = node_get_types('type', $node);

  if ($type->has_title) {
    $form['title'] = array(
      '#type' => 'textfield',
      '#title' => check_plain($type->title_label),
      '#required' => TRUE,
      '#default_value' => $node->title,
      '#weight' => -5
    );
  }

  if ($type->has_body) {
    // In Drupal 6, we use node_body_field() to get the body and filter
    // elements. This replaces the old textarea + filter_form() method of
    // setting this up. It will also ensure the teaser splitter gets set up
    // properly.
    $form['body_field'] = node_body_field($node, $type->body_label, $type->min_word_count);
  }

  // Now we define the form elements specific to our node type.
  $form['color'] = array(
    '#type' => 'textfield',
    '#title' => t('Color'),
    '#default_value' => isset($node->color) ? $node->color : '',
  );
  $form['quantity'] = array(
    '#type' => 'textfield',
    '#title' => t('Quantity'),
    '#default_value' => isset($node->quantity) ? $node->quantity : 0,
    '#size' => 10,
    '#maxlength' => 10
  );

  return $form;
}

/**
 * Implementation of hook_validate().
 *
 * Our "quantity" field requires a number to be entered. This hook lets
 * us ensure that the user entered an appropriate value before we try
 * inserting anything into the database.
 *
 * Errors should be signaled with form_set_error().
 */
function boletin_grupo_validate($node, &$form) {
  if ($node->quantity) {
    if (!is_numeric($node->quantity)) {
      form_set_error('quantity', t('The quantity must be a number.'));
    }
  }
}

/**
 * Implementation of hook_insert().
 *
 * As a new node is being inserted into the database, we need to do our own
 * database inserts.
 */
function boletin_grupo_insert($node) {
  db_query("INSERT INTO {boletin_grupo} (vid, nid, color, quantity) VALUES (%d, %d, '%s', %d)", $node->vid, $node->nid, $node->color, $node->quantity);
}

/**
 * Implementation of hook_update().
 *
 * As an existing node is being updated in the database, we need to do our own
 * database updates.
 */
function boletin_grupo_update($node) {
  // if this is a new node or we're adding a new revision,
  if ($node->revision) {
    boletin_grupo_insert($node);
  }
  else {
    db_query("UPDATE {boletin_grupo} SET color = '%s', quantity = %d WHERE vid = %d", $node->color, $node->quantity, $node->vid);
  }
}

/**
 * Implementation of hook_nodeapi().
 *
 * When a node revision is deleted, we need to remove the corresponding record
 * from our table. The only way to handle revision deletion is by implementing
 * hook_nodeapi().
 */
function boletin_grupo_nodeapi(&$node, $op, $teaser, $page) {
  switch ($op) {
    case 'delete revision':
      // Notice that we're matching a single revision based on the node's vid.
      db_query('DELETE FROM {boletin_grupo} WHERE vid = %d', $node->vid);
      break;
  }
}

/**
 * Implementation of hook_delete().
 *
 * When a node is deleted, we need to remove all related records from our table.
 */
function boletin_grupo_delete($node) {
  // Notice that we're matching all revision, by using the node's nid.
  db_query('DELETE FROM {boletin_grupo} WHERE nid = %d', $node->nid);
}

/**
 * Implementation of hook_load().
 *
 * Now that we've defined how to manage the node data in the database, we
 * need to tell Drupal how to get the node back out. This hook is called
 * every time a node is loaded, and allows us to do some loading of our own.
 */
function boletin_grupo_load($node) {
  $additions = db_fetch_object(db_query('SELECT color, quantity FROM {boletin_grupo} WHERE vid = %d', $node->vid));
  return $additions;
}

/**
 * Implementation of hook_view().
 *
 * This is a typical implementation that simply runs the node text through
 * the output filters.
 */
function boletin_grupo_view($node, $teaser = FALSE, $page = FALSE) {
  $node = node_prepare($node, $teaser);
  $node->content['myfield'] = array(
    '#value' => theme('boletin_grupo_order_info', $node),
    '#weight' => 1,
  );

  return $node;
}

/**
 * Implementation of hook_theme().
 *
 * This lets us tell Drupal about our theme functions and their arguments.
 */
function boletin_grupo_theme() {
  return array(
    'boletin_grupo_order_info' => array(
      'arguments' => array('node'),
    ),
  );
}

/**
 * A custom theme function.
 *
 * By using this function to format our node-specific information, themes
 * can override this presentation if they wish. We also wrap the default
 * presentation in a CSS class that is prefixed by the module name. This
 * way, style sheets can modify the output without requiring theme code.
 */
function theme_boletin_grupo_order_info($node) {
  $output = '<div class="boletin_grupo_order_info">';
  $output .= t('The order is for %quantity %color items.', array('%quantity' => check_plain($node->quantity), '%color' => check_plain($node->color)));
  $output .= '</div>';
  return $output;
}

/**
 * @} End of "defgroup boletin_grupo".
 */

function boletin_grupo_block($op = 'list', $delta = 0, $edit = array()) {
 	switch ($op) {
    	case 'list':

                        $blocks[1200]['info'] = t('Manage Group Bulletin');

			return $blocks;
			break;

		case 'view':
			$block=my_boletin_grupo_view_block($delta);
   			return $block;
		default:
			break;
	}
}
function my_boletin_grupo_view_block($delta){
	$block=array();
	switch($delta){
		case 1200:
                        if(user_access('Ver boletin_del_grupo')){

                            $block['subject'] = t('Group Bulletin');
                            $block['content'] = get_boletin_del_grupo_content();
                        }
			break;
		default:
			break;
 	}
    return $block;
}
function get_boletin_del_grupo_content(){
    	$result=array();
	$result[]=l(t('Group Bulletin'),'boletin_grupo');
	return implode('<BR>',$result);
}
//intelsat-2015
//function get_acciones_boletin_grupo($r){
function get_acciones_boletin_grupo($r,$is_alerta_publico=0){
    global $user;
    $html=array();
    //recibir si/no boletin
    $is_activo=is_activo_boletin_grupo_user($r->nid,$user->uid);    
    $icono_no_recibir=my_get_icono_action('si_recibir', t("I'd like to subscribe"));        
    if($is_activo){
        $icono_no_recibir=my_get_icono_action('no_recibir', t("I'd like to unsubscribe"));
    }
    //intelsat-2015
    //if(!hontza_is_user_anonimo()){
    if(!$is_alerta_publico){
        $html[]=l($icono_no_recibir,'boletin_grupo/'.$r->nid.'/my_no_recibir',array('html'=>true,'query'=>drupal_get_destination()));
    }
    //
    $atzizkia='';    
    /*if(in_array($r->tipo,array('categoria','usuario'))){
        $atzizkia='_'.$r->tipo;
    }*/
    //if(is_permiso_gestion_boletin_grupo($r->nid,1,'',1)){
    //if(is_permiso_editar_boletin_grupo($r->nid)){
    //intelsat-2015
    //if(!hontza_is_user_anonimo()){
    if(!$is_alerta_publico){
        if(boletin_report_is_permiso_editar($r->nid)){
            $html[]=l(my_get_icono_action('edit', t('Edit')),'boletin_grupo/'.$r->nid.'/my_edit'.$atzizkia,array('html'=>true,'query'=>drupal_get_destination()));
            //$html[]=l(my_get_icono_action('delete', t('Delete')),'boletin_grupo/'.$r->nid.'/my_delete'.$atzizkia,array('html'=>true,'query'=>drupal_get_destination()));
        }
    }
    $url='boletin_grupo/'.$r->nid.'/my_web';
    //intelsat-2015
    //if(hontza_canal_rss_is_publico_activado()){
    if($is_alerta_publico){
        //if(hontza_is_user_anonimo()){
           $url='publico_boletin_grupo/'.$r->nid.'/my_web'; 
        //}
    }
    //intelsat-2015
    $options_view_next_group_bulletin=red_despacho_boletin_report_get_options_view_next_group_bulletin();
    $html[]=l(my_get_icono_action('viewmag', t('View Next Group Bulletin')),$url,$options_view_next_group_bulletin);
    //intelsat-2015
    //if(!hontza_is_user_anonimo()){
    if(!$is_alerta_publico){
        if(is_permiso_gestion_boletin_grupo($r->nid)){
            if(isset($r->id) && !empty($r->id)){
                $my_nid=get_grupo_boletin_introduccion_nid($r->nid);
                //print $my_nid;
                if(empty($my_nid)){
                    $html[]=l(my_get_icono_action('introduccion', t('Header')),'node/add/boletin-grupo-introduccion/'.$r->nid,array('html'=>true,'query'=>drupal_get_destination()));
                }else{
                    $html[]=l(my_get_icono_action('introduccion', t('Header')),'node/'.$my_nid.'/edit',array('html'=>true,'query'=>drupal_get_destination()));

                }
                //
                $my_nid=get_grupo_boletin_despedida_nid($r->nid);
                //print $my_nid;
                if(empty($my_nid)){
                    $html[]=l(my_get_icono_action('despedida', t('Footer')),'node/add/boletin-grupo-despedida/'.$r->nid,array('html'=>true,'query'=>drupal_get_destination()));
                }else{
                    $html[]=l(my_get_icono_action('despedida', t('Footer')),'node/'.$my_nid.'/edit',array('html'=>true,'query'=>drupal_get_destination()));

                }
            }

        }
    }
    
    //$html[]=l(my_get_icono_action('delete', t('Delete')),'alerta_user/'.$r->id.'/my_delete'.$atzizkia,array('html'=>true,'query'=>drupal_get_destination()));
    return add_div_actions(implode('&nbsp;',$html),1,'','boletin_grupo');
}
function boletin_grupo_my_edit_form(){
    $grupo_nid='';
    $row=get_boletin_grupo_row(arg(1));
    if(isset($row->grupo_nid) && !empty($row->grupo_nid)){
        $grupo_nid=$row->grupo_nid;
    }else{
        $grupo_nid=arg(1);
    }
    //echo print_r($row,1);
    //if(!is_permiso_editar_boletin_grupo($row->grupo_nid)){
    //if(!is_permiso_gestion_boletin_grupo($grupo_nid,1,'',1)){
    if(!boletin_report_is_permiso_editar($grupo_nid)){
        drupal_access_denied();
        exit();
    }

    $form=array();
    $form['#attributes'] = array('enctype' => "multipart/form-data");

    $form['alerta_user_menu']=array();
    $form['alerta_user_menu']['#value']=create_menu_alerta_user(); 
    
    
//echo '-----'.print_r($row,1);exit();
    if(isset($row->id) && !empty($row->id)){
        $form['my_id']=array(
            '#type'=>'hidden',
            '#default_value' =>$row->id,
        );
    }

    $form['grupo_nid']=array(
            '#type'=>'hidden',
            '#default_value' =>arg(1),
        );

$form['activado48']=array(
            '#value' =>get_icono_activado_by_row($row,1),
        );

$form['receptores_fs']=array(
    '#type'=>'fieldset',
    '#title'=>t('Recipients of the Bulletin'),
    '#collapsible'=>TRUE,
);
            $form['receptores_fs']['is_todos_usuarios']=array(
              '#type'=>'checkbox',
              '#title'=>t('All users'),
            );
            if((isset($row->is_todos_usuarios) && !empty($row->is_todos_usuarios)) || !isset($row->is_todos_usuarios)){
                $form['receptores_fs']['is_todos_usuarios']['#attributes']=array('checked'=>'checked');
            }


        $form['receptores_fs']['usuarios'] = array(
          '#type' => 'select',
          '#title' => t('Users'),
          '#default_value' => $row->usuarios,
          '#options'=>get_usuarios_grupo_options(arg(1)),
          '#multiple'=>TRUE,
          '#size'=>20,
          '#required' => FALSE
          );

/*$form['formato_fs']=array(
    '#type'=>'fieldset',
    '#title'=>t('Formato'),
    '#collapsible'=>TRUE,
);

$form['formato_fs']['introduccion']=array(
    '#type'=>'textarea',
    '#title'=>t('Header'),
    '#default_value'=>$row->introduccion,
);*/

/*$form['formato_fs']['imagen_introduccion']=array(
    '#type'=>'file',
    '#title'=>t('Logo Introduccion'),
);*/

/*$form['formato_fs']['despedida']=array(
    '#type'=>'textarea',
    '#title'=>t('Footer'),
    '#default_value'=>$row->despedida,
);*/

/*$form['formato_fs']['imagen_despedida']=array(
    '#type'=>'file',
    '#title'=>t('Logo Despedida'),
);*/

//$form['formato2_fs']['format'] = filter_form(1);

//
$form['contenidos_fs']=create_contenidos_fieldset_txek($row);
$form['limites_fs']=create_limites_fieldset($row);
//
$form['metodo_fs']=array(
    '#type'=>'fieldset',
    '#title'=>t('Method and Frequency'),
    '#collapsible'=>TRUE,
);

$form['metodo_fs']['activado'] = array(
        '#type' => 'checkbox',
        '#title' => t('Active'),
        //'#value' => 1,
        //'#required' => TRUE
      );

//
if(is_activado_boletin_grupo_by_row($row)){
    $form['metodo_fs']['activado']['#attributes']=array('checked'=>'checked');
}
//


$form['metodo_fs']['send_method'] = array(
        '#type' => 'select',
        '#title' => t('Select Sending Method'),
        '#options' => my_get_methods(),
        '#default_value' => $row->send_method,
        '#required' => TRUE,
        //intelsat-2015
        '#prefix'=>'<div style="display:none;">',
        '#suffix'=>'</div>',
        //
      );
$form['metodo_fs']['frecuencia'] = array(
        '#type' => 'select',
        '#title' => t('Frequency'),
        '#options' => get_frecuencia_options(1),
        '#default_value' => $row->frecuencia,
        '#required' => TRUE
      );

$form['metodo_fs']['hora_array'] = array(
      '#type' => 'alerta_time',
        '#title' => t('Time'),
        '#default_value' => $row->hora,
        '#required' => TRUE
);




$form['boleting_grupo_btn_submit']=array(
  '#type' => 'submit',
  '#value' => t('Save'),
);

$form['boletin_grupo_volver']=array(
  //'#value' => l(t('Return'),$_REQUEST['destination'],array('attributes'=>array('id'=>'my_volver_alerta_user','class'=>'back_left'))),
  '#value' => l(t('Cancel'),$_REQUEST['destination']),

);


return $form;
}
function get_boletin_grupo_row($grupo_nid){
    
    if(!empty($grupo_nid) && is_numeric($grupo_nid)){
        $boletin_grupo_list=get_boletin_grupo_list($grupo_nid);
        if(count($boletin_grupo_list)>0){
            //echo print_r($boletin_grupo_list[0],1);exit();
            return $boletin_grupo_list[0];
        }
    }
    //
    $my_result=array();
    $my_result=(object) $my_result;
    return $my_result;
}
function get_boletin_grupo_list($grupo_nid=''){
    $result=array();
    //
    $where=array();
    $where[]='1';
    if(!empty($grupo_nid)){
        $where[]='bg.grupo_nid='.$grupo_nid;
    }
    $sql='SELECT bg.*
    FROM {boletin_grupo_array} bg
    WHERE '.implode(' AND ',$where).'
    ORDER BY bg.created ASC';
    //
    $res=db_query($sql);
    $kont=0;
    while($row=db_fetch_object($res)){
        $result[$kont]=$row;
        $result[$kont]->usuarios=get_boletin_usuarios_id_array($row->id,$grupo_nid,0);
        $kont++;
    }
    return $result;
}
function boletin_grupo_my_edit_form_submit(&$form, &$form_state){
    save_boletin_grupo_my_edit($form, $form_state);
}
function save_boletin_grupo_my_edit(&$form, &$form_state){
    global $user;
    $values=$form_state['values'];
    //echo print_r($values,1);exit();
    //echo print_r($_FILES,1);exit();
    //
    $hora=str_pad($values['hora_array']['hour'], 2, '0', STR_PAD_LEFT).':'.str_pad($values['hora_array']['minute'], 2, '0', STR_PAD_LEFT);
    $created=time();
    //
    $is_todos_usuarios=$values['is_todos_usuarios'];
    //
    $c=array();
    $la=array();
    $contenido_fields=create_contenido_fields();
    foreach($contenido_fields as $i=>$f){
        $name=$f['name'];
        $c[$f['name']]=$values[$name];
        $limite_name=str_replace('is_','limite_',$f['name']);
        $la[$limite_name]=get_alerta_my_limite($values[$limite_name]);
    }
    //$la['limite_noticias_destacadas']=get_alerta_my_limite($values['limite_noticias_destacadas'],3);
    $la['limite_noticias_destacadas']=get_alerta_my_limite($values['limite_noticias_destacadas'],0);
    $la['apply_limite_resumen']=0;
    if(isset($values['apply_limite_resumen']) && !empty($values['apply_limite_resumen'])){
        $la['apply_limite_resumen']=1;
    }
    //$la['limite_resumen']=get_alerta_my_limite($values['limite_resumen'],boletin_grupo_define_max_limite_resumen());
    $la['limite_resumen']=$values['limite_resumen'];
    $activado=$values['activado'];
    //
    $la['apply_limite_resumen_comentario']=0;
    if(isset($values['apply_limite_resumen_comentario']) && !empty($values['apply_limite_resumen_comentario'])){
        $la['apply_limite_resumen_comentario']=1;         
    }
    //$la['limite_resumen_comentario']=get_alerta_my_limite($values['limite_resumen_comentario'],boletin_grupo_define_max_limite_resumen_comentario());
    $la['limite_resumen_comentario']=$values['limite_resumen_comentario'];
    //
    //$introduccion='';
    //$despedida='';
    //
    if(isset($values['my_id']) && !empty($values['my_id']) && is_numeric($values['my_id'])){
        $changed=$created;
        $sql=sprintf('UPDATE boletin_grupo_array SET send_method="%s",frecuencia="%s",hora="%s",changed=%d,is_todos_usuarios=%d,is_todos_validados=%d,is_todos_noticias_usuario=%d,is_todos_comentarios=%d,is_todos_foros_wikis=%d,is_todos_idea_opor_proy=%d,limite_todos_validados=%d,limite_todos_noticias_usuario=%d,limite_todos_comentarios=%d,limite_todos_foros_wikis=%d,limite_todos_idea_opor_proy=%d,limite_noticias_destacadas=%d,activado=%d,limite_resumen=%d,apply_limite_resumen=%d,limite_resumen_comentario=%d,apply_limite_resumen_comentario=%d WHERE id=%d',$values['send_method'],$values['frecuencia'],$hora,$changed,$is_todos_usuarios,$c['is_todos_validados'],$c['is_todos_noticias_usuario'],$c['is_todos_comentarios'],$c['is_todos_foros_wikis'],$c['is_todos_idea_opor_proy'],$la['limite_todos_validados'],$la['limite_todos_noticias_usuario'],$la['limite_todos_comentarios'],$la['limite_todos_foros_wikis'],$la['limite_todos_idea_opor_proy'],$la['limite_noticias_destacadas'],$activado,$la['limite_resumen'],$la['apply_limite_resumen'],$la['limite_resumen_comentario'],$la['apply_limite_resumen_comentario'],$values['my_id']);
        db_query($sql);
    }else{
        $sql=sprintf('INSERT INTO boletin_grupo_array(send_method,frecuencia,hora,created,uid,grupo_nid,is_todos_usuarios,is_todos_validados,is_todos_noticias_usuario,is_todos_comentarios,is_todos_foros_wikis,is_todos_idea_opor_proy,limite_todos_validados,limite_todos_noticias_usuario,limite_todos_comentarios,limite_todos_foros_wikis,limite_todos_idea_opor_proy,limite_noticias_destacadas,activado,limite_resumen,apply_limite_resumen,limite_resumen_comentario,apply_limite_resumen_comentario) VALUES("%s","%s","%s",%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d)',$values['send_method'],$values['frecuencia'],$hora,$created,$user->uid,$values['grupo_nid'],$is_todos_usuarios,$c['is_todos_validados'],$c['is_todos_noticias_usuario'],$c['is_todos_comentarios'],$c['is_todos_foros_wikis'],$c['is_todos_idea_opor_proy'],$la['limite_todos_validados'],$la['limite_todos_noticias_usuario'],$la['limite_todos_comentarios'],$la['limite_todos_foros_wikis'],$la['limite_todos_idea_opor_proy'],$la['limite_noticias_destacadas'],$activado,$la['limite_resumen'],$la['apply_limite_resumen'],$la['limite_resumen_comentario'],$la['apply_limite_resumen_comentario']);
        db_query($sql);
    }
    $row=get_boletin_grupo_row($values['grupo_nid']);
    save_boletin_grupo_usuarios($row->id,$values['usuarios']);
}
function get_usuarios_grupo_options($grupo_nid,$with_empty=0,$is_create_grupo=0){
	$result=array();
        if($with_empty){
            $result[0]='';
        }
        if(!empty($grupo_nid) && is_numeric($grupo_nid)){
            //$is_invitado=0;
            $is_invitado=1;
            $user_list=my_get_og_grupo_user_list($grupo_nid,$is_invitado);
            if(count($user_list)>0){
                    foreach($user_list as $i=>$u){
                            $result[$u->uid]=$u->name;
                    }
            }
            //echo print_r($result,1);
        }else{
           //gemini-2013 
           if(is_node_add('grupo')){
                $result=get_usuarios_creadores_y_administradores_grupo_options();
           }else{               
                $result=array();
                $result[1]='admin';
           }        
        }
        return $result;
}
function save_boletin_grupo_usuarios($id,$subgrupo){
	global $user;
        //echo print_r($subgrupo,1);exit();
        //
        //$is_todo_subgrupo=1;
        my_delete_boletin_grupo_usuarios($id);
	if(count($subgrupo)>0){
            foreach($subgrupo as $i=>$uid){
                insert_boletin_grupo_usuarios($id,$uid);
            }
            //$is_todo_subgrupo=0;
            /*if(!is_user_in_subgrupo($user->uid,$subgrupo)){
                insert_idea_subgrupo($idea_nid,$user->uid);
            }*/
	}
        //update_is_todo_subgrupo($idea_nid,$is_todo_subgrupo);
}
function my_delete_boletin_grupo_usuarios($id){
	$sql='DELETE FROM {boletin_grupo_array_usuarios} WHERE boletin_grupo_array_id='.$id;
	db_query($sql);
}
function insert_boletin_grupo_usuarios($id,$uid){
	$sql='INSERT boletin_grupo_array_usuarios(boletin_grupo_array_id,uid) VALUES('.$id.','.$uid.')';
	//print $sql.'<BR>';
        db_query($sql);
}
function get_boletin_usuarios_id_array($id,$grupo_nid,$is_default=0){
    $result=array();
    $my_list=get_boletin_usuarios_list($id);
    if(count($my_list)>0){
        foreach($my_list as $i=>$row){
            $result[]=$row->uid;
        }
    }else{
        if($is_default){
            $options=get_usuarios_grupo_options($grupo_nid);
            $result=array_keys($options);
            //echo print_r($result,1);
        }
    }
    return $result;
}
function get_boletin_usuarios_list($id){
    $result=array();
    $where=array();
    $where[]='1';
    $where[]='boletin_grupo_array_id='.$id;
    $sql='SELECT * FROM boletin_grupo_array_usuarios WHERE '.implode(' AND ',$where);
    $res=db_query($sql);
    while($row=db_fetch_object($res)){
        $result[]=$row;
    }
    return $result;
}
function create_contenidos_fieldset_txek($row){
    $result=array();
    $result['contenidos_fs']=array(
    '#type'=>'fieldset',
    '#title'=>t('Contents'),
    '#collapsible'=>TRUE,
);
    //
    $my_array=create_contenido_fields();
    //
    foreach($my_array as $i=>$field){
        $result['contenidos_fs'][$field['name']]=array(
              '#type'=>'checkbox',
              '#title'=>$field['label'],
            );
        $f=$field['name'];
       // print $f.'<BR>';
        if((isset($row->$f) && !empty($row->$f)) || !isset($row->$f)){
                $result['contenidos_fs'][$f]['#attributes']=array('checked'=>'checked');
        }
    }
    //
    return $result;
}
function create_contenido_fields(){
    $my_array=array();
    //
    $my_array[0]['name']='is_todos_validados';
    $my_array[0]['label']=t('News');
    //
    $my_array[1]['name']='is_todos_noticias_usuario';
    $my_array[1]['label']=t('User news');
    //
    //$my_array[2]['name']='is_todos_comentarios';
    //$my_array[2]['label']=t('Comments');
    //
    //intelsat-2015
    if(!red_despacho_is_activado()){
        $my_array[2]['name']='is_todos_foros_wikis';
        $my_array[2]['label']=t('Discussions and Wikis');
        //
        $my_array[3]['name']='is_todos_idea_opor_proy';
        $my_array[3]['label']=t('Ideas, Opportunities and Projects');
    }
    return $my_array;
}
function get_boletin_txek_field($name){
    $my_array=create_contenido_fields();
    if(count($my_array)>0){
       foreach($my_array as $i=>$row){
           if($row['name']==$name){
               return $row;
           }
       }
    }
    //
    $my_result=array();
    
    return $my_result;
}
function my_create_boton_boletin_cron(){
    //gemini-2014
    return '';
    //
    $html='';
    if(is_permiso_gestion_boletin_grupo('')){
        $html=l(t('Launch Mail Queue'),'alerta/my_execute_cron');
        //$html=l(t('Copiar ayuda'),'my_copiar_ayuda');
    }
    return $html;
}
function create_limites_fieldset($row){
    $result=array();
    $result['limites_fs']=array(
    '#type'=>'fieldset',
    '#title'=>t('Limits'),
    '#collapsible'=>TRUE,
);
    //
    $my_array=create_contenido_fields();
    //
    foreach($my_array as $i=>$field){
        $name=str_replace('is_','limite_',$field['name']);
        $result['limites_fs'][$name]=array(
              '#type'=>'textfield',
              '#title'=>t('Limit of').' '.$field['label'],
              '#default_value'=>get_alerta_my_limite($row->$name),
            );        
    }
    //
    $result['limites_fs']['limite_noticias_destacadas']=array(
              '#type'=>'textfield',
              '#title'=>t('Limit of highlighted news'),
              //'#default_value'=>get_alerta_my_limite($row->limite_noticias_destacadas,3),
              '#default_value'=>get_alerta_my_limite($row->limite_noticias_destacadas,0),
            );

    $result['limites_fs']['apply_limite_resumen']=array(
              '#type'=>'checkbox',
              '#title'=>t('Limit Abstract Length'),
            );
            if((isset($row->apply_limite_resumen) && !empty($row->apply_limite_resumen)) || !isset($row->id)){
                $result['limites_fs']['apply_limite_resumen']['#attributes']=array('checked'=>'checked');
            }
    
    $limite_resumen=red_despacho_boletin_report_get_limite_resumen($row);        
    $result['limites_fs']['limite_resumen']=array(
              '#type'=>'textfield',
              '#title'=>t('Abstract Length'),
              //'#default_value'=>get_alerta_my_limite($row->limite_resumen,boletin_grupo_define_max_limite_resumen()),
              '#default_value'=>$limite_resumen,              
              '#required' => TRUE
            );
    //intelsat-2015
    $display=red_despacho_boletin_report_get_limit_comments_length_display();  
    $result['limites_fs']['apply_limite_resumen_comentario']=array(
              '#type'=>'checkbox',
              '#title'=>t('Limit Comment Length'),
            );
            if((isset($row->apply_limite_resumen_comentario) && !empty($row->apply_limite_resumen_comentario)) || !isset($row->id)){
                $result['limites_fs']['apply_limite_resumen_comentario']['#attributes']=array('checked'=>'checked');
            }
    //intelsat-2015
    if(red_despacho_is_activado() && !empty($display)){        
        $result['limites_fs']['apply_limite_resumen_comentario']['#prefix']='<div style="'.$display.'">';
        $result['limites_fs']['apply_limite_resumen_comentario']['#suffix']='</div>';
    }
    $limite_resumen_comentario=red_despacho_boletin_report_get_limite_resumen_comentario($row);        
    $result['limites_fs']['limite_resumen_comentario']=array(
              '#type'=>'textfield',
              '#title'=>t('Comment Length'),
              //'#default_value'=>get_alerta_my_limite($row->limite_resumen_comentario,boletin_grupo_define_max_limite_resumen_comentario()),
              '#default_value'=>$limite_resumen_comentario,
              '#required' => TRUE
            );
    //intelsat-2015
    if(red_despacho_is_activado() && !empty($display)){
        $result['limites_fs']['limite_resumen_comentario']['#prefix']='<div style="'.$display.'">';
        $result['limites_fs']['limite_resumen_comentario']['#suffix']='</div>';
    }
    //
    return $result['limites_fs'];
}
function boletin_grupo_web_callback(){
    //gemini-2014
    drupal_set_title(t('View Group Bulletin'));
    return ver_boletin_grupo_web();
}
function ver_boletin_grupo_web(){
    $content='';
    $content.=create_menu_alerta_user();
    $grupo_nid=arg(1);
    $dia=date('N');
    $nombre_dia=get_nombre_dia($dia);
    $bg_list=get_boletin_grupo_list($grupo_nid);
    if(count($bg_list)>0){
        $bg=$bg_list[0];
        $por_correo=0;
        $content.=call_boletin_grupo($bg,$nombre_dia,$por_correo);
        //if(red_despacho_is_activado()){    
        if(red_dashboard_is_despacho_no_dashboard()){    
            print $content;
            exit();
        }    
    }
    /*$volver=l(t('Return'),$_REQUEST['destination'],array('attributes'=>array('class'=>'back_left')));
    //
    $content=$volver.$content;*/
    return $content;
}
function boletin_grupo_table(){    
    global $user;
    //gemini-2014
    //drupal_set_title(t('Groups Bulletins'));
    drupal_set_title(t('Group Bulletin'));
    //
    //$uid=arg(1);
    $output='';
    //
    $where=array();
    $where[]='1';
    //intelsat-2015
    if(hontza_canal_rss_is_publico_activado()){
        if(!publico_is_pantalla_publico('alerta_user','mis_boletines_grupo')){
            $where[]='ou.uid='.$user->uid;
        }
    }else{
        $where[]='ou.uid='.$user->uid;
    }
    //
    $where[]='n.type="grupo"';
    //gemini-2014
    $my_grupo=og_get_group_context();
    if(isset($my_grupo->nid) && !empty($my_grupo->nid)){
        $where[]='n.nid='.$my_grupo->nid;
    }
    //
    /*if($user->uid!=$uid){
        return t('You can not edit the Personalized alert from other user');
    }*/
    //$result=drupal_get_form('alerta_user_form');

    //
    $my_limit=variable_get('default_nodes_main', 10);
    //
    $sort='asc';
    $field='title';
    if(isset($_REQUEST['sort']) && !empty($_REQUEST['sort'])){
        $sort=$_REQUEST['sort'];
    }
    //$is_numeric=0;
    if(isset($_REQUEST['order']) && !empty($_REQUEST['order'])){
        $order=$_REQUEST['order'];
        if($order==t('Group')){
            $field='title';
        }else if($order==t('Method')){
            $field='send_method';
        }else if($order==t('Frecuency')){
            $field='frefuency';
        }else if($order==t('Time')){
            $field='hora';
        }else if($order==t('Creation date')){
            $field='created';
        }
    }
    //
    $sql='SELECT n.title,n.nid,bg.*
    FROM {node} n
    LEFT JOIN {og_uid} ou ON n.nid=ou.nid
    LEFT JOIN {boletin_grupo_array} bg ON n.nid=bg.grupo_nid
    WHERE '.implode(' AND ',$where).'
    GROUP BY n.nid
    ORDER BY '.$field.' '.$sort;
    $res = db_query($sql);
    /*
    $headers=array();
    $headers[0]=t('Group');
    $headers[1]=t('Method');
    $headers[2]=t('Frequency');
    $headers[3]=t('Time');
    $headers[4]=t('Created');
    $headers[5]=t('I wish to receive');
    $headers[6]=t('Actions');*/
    $headers=boletin_grupo_define_table_headers();
    
    //intelsat-2015
    $is_alerta_publico=hontza_canal_rss_is_alerta_publico();    
    $rows=array();
    $output.=create_menu_alerta_user();
    //$output.=my_create_boton_boletin_volver();
    $output.=my_create_boton_boletin_cron();
    $kont=0;
    while ($r = db_fetch_object($res)) {
      $rows[$kont]=array();
      $icono_activado=get_icono_activado_by_row($r);
      $rows[$kont][0]=$icono_activado.'&nbsp;'.$r->title;
      $rows[$kont][1]=get_metodo_name($r->send_method);
      $rows[$kont][2]=get_label_frecuencia($r->frecuencia);
      $rows[$kont][3]=$r->hora;
      $rows[$kont][4]='';
      if(!empty($r->created)){
        $rows[$kont][4]=date('Y-m-d',$r->created);
      }
      //intelsat-2015
      $rows[$kont][5]=alerta_get_img_alerta_personal_recibir($r->activado);
      $url_archivo='boletin_grupo/'.$r->nid.'/historico';
      //if(hontza_canal_rss_is_publico_activado()){
      //  if(hontza_is_user_anonimo()){
          if($is_alerta_publico){  
            $url_archivo='publico_boletin_grupo/'.$r->nid.'/historico';
          }  
      //}
      $rows[$kont][6]=l(my_get_icono_action('boletin_historico', t('Archive')),$url_archivo,array('absolute'=>TRUE,'html'=>true,'query'=>drupal_get_destination(),'attributes'=>array('title'=>t('Archive'),'alt'=>t('Archive'))));                      
      //
      //$rows[$kont][5]=get_value_no_recibir($r);
      //intelsat-2015
      //$rows[$kont][7]=get_acciones_boletin_grupo($r);
      $rows[$kont][7]=get_acciones_boletin_grupo($r,$is_alerta_publico);
      //gemini-2014
      unset($rows[$kont][1]);
      unset($rows[$kont][4]);
      $rows[$kont]=array_values($rows[$kont]);
      //
      $kont++;
    }


    $rows=my_set_estrategia_pager($rows, $my_limit);


  if (count($rows)>0) {
    /*$feed_url = url('idea_rss.xml', array('absolute' => TRUE));
    drupal_add_feed($feed_url, variable_get('site_name', 'Drupal') . ' ' . t('RSS'));*/
    $output .= theme('table',$headers,$rows);
    $output .= theme('pager', NULL, $my_limit);
  }
  else {

    $output.= '<div id="first-time">' .t('There are no group bulletins for this user'). '</div>';
  }
  //drupal_set_title(t('Listado de ideas'));

  return $output;
}
function is_permiso_gestion_boletin_grupo($grupo_nid,$is_session=1,$uid_konp='',$es_solo_edit=0){
    global $user;
    if($is_session){
        if($user->uid==1){
            return 1;
        }
    }
    if(!empty($grupo_nid)){
        $grupo=node_load($grupo_nid);
        if(isset($grupo->nid) && !empty($grupo->nid)){
            $uid=0;
            if(isset($grupo->field_admin_grupo_uid[0]['uid'])){
                $uid=$grupo->field_admin_grupo_uid[0]['uid'];
            }else if(isset($grupo->field_admin_grupo_uid[0]['value'])){
                $uid=$grupo->field_admin_grupo_uid[0]['value'];
            }
            if($is_session){
                if($user->uid==$uid){
                    return 1;
                }
            }else{
                if($uid_konp==$uid){
                    return 1;
                }
            }
            if(is_user_creador_de_grupo_del_grupo($user,$grupo)){
                return 1;
            }
            //intelsat-2016
            if(hontza_grupos_mi_grupos_is_user_admistrador_grupo_propietario($user,$grupo)){
                return 1;
            }
            if(hontza_grupos_mi_grupo_is_creador_administrador_grupo($user)){
                return 1;
            }
        }
    }
    if($es_solo_edit){
        if(in_user_groups($grupo_nid,$user)){
            if(is_user_administrador_de_grupo($user)){
                return 1;
            }
        }
    }
    return 0;
}
function my_create_boton_boletin_volver(){
    global $user;
    $param=arg(0);
    
        if(strcmp($param,'boletin_grupo')==0){
            $dest='gestion';
        }else{
            //$dest='user/'.$user->uid.'/alerta_user';
            $dest='alerta_user/'.$user->uid.'/my_list';
        }
        
    $volver=l(t('Return'),$dest,array('attributes'=>array('class'=>'back_left')));
    return $volver;
}
function my_boletin_grupo_introduccion_node_form_alter(&$form,&$form_state,$form_id){
    if($form_id=='boletin_grupo_introduccion_node_form'){
        permiso_introduccion_despedida_access();
        hontza_add_form_menu_alerta_user($form);
    }    
    if(strcmp(arg(0),'node')==0 && strcmp(arg(1),'add')==0 && strcmp(arg(2),'boletin-grupo-introduccion')==0 && is_numeric(arg(3))){
        //intelsat-2015
        drupal_set_title(t('Create Header'));        
        $form['field_introduccion_grupo_nid'][0]['#default_value']['value']=arg(3);
    }
}
function get_grupo_boletin_introduccion_nid($nid){
    $my_list=get_content_type_boletin_grupo_introduccion_list($nid);
    if(count($my_list)>0){
        //echo print_r($my_list,1);
        return $my_list[0]->nid;
    }
    return '';
}
function get_content_type_boletin_grupo_introduccion_list($nid){
    $result=array();
    if(empty($nid)){
        return $result;
    }
    $where=array();
    $where[]="1";
    $where[]="c.field_introduccion_grupo_nid_value =".$nid;
    $sql="SELECT c.* FROM {content_type_boletin_grupo_introduccion} c WHERE ".implode(" AND ",$where)." ORDER BY c.nid DESC";
    //print $sql.'<BR>';
    $res=db_query($sql);
    while($row=db_fetch_object($res)){
        $result[]=$row;
    }
    return $result;
}
function get_grupo_boletin_despedida_nid($nid){
    $my_list=get_content_type_boletin_grupo_despedida_list($nid);
    if(count($my_list)>0){
        //echo print_r($my_list,1);
        return $my_list[0]->nid;
    }
    return '';
}
function get_content_type_boletin_grupo_despedida_list($nid){
    $result=array();
    if(empty($nid)){
        return $result;
    }
    $where=array();
    $where[]="1";
    $where[]="c.field_despedida_grupo_nid_value =".$nid;
    $sql="SELECT c.* FROM {content_type_boletin_grupo_despedida} c WHERE ".implode(" AND ",$where)." ORDER BY c.nid DESC";
    //print $sql.'<BR>';
    $res=db_query($sql);
    while($row=db_fetch_object($res)){
        $result[]=$row;
    }
    return $result;
}
function my_boletin_grupo_despedida_node_form_alter(&$form,&$form_state,$form_id){
    if($form_id=='boletin_grupo_despedida_node_form'){
        permiso_introduccion_despedida_access();
        hontza_add_form_menu_alerta_user($form);
    }
    if(strcmp(arg(0),'node')==0 && strcmp(arg(1),'add')==0 && strcmp(arg(2),'boletin-grupo-despedida')==0 && is_numeric(arg(3))){
        //intelsat-2015
        drupal_set_title(t('Create Footer'));
        $form['field_despedida_grupo_nid'][0]['#default_value']['value']=arg(3);
    }
}
function get_boletin_grupo_destacadas_limit($grupo){    
    if(isset($grupo->nid) && !empty($grupo->nid)){
        $bg_list=get_boletin_grupo_list($grupo->nid);
        if(count($bg_list)>0){
            //echo print_r($bg_list,1);exit();
            //return get_alerta_my_limite($bg_list[0]->limite_noticias_destacadas, 3);
            return get_alerta_my_limite($bg_list[0]->limite_noticias_destacadas, 0);
        }
    }
    //return 3;
    return 0;
}
function my_implode_destacadas_html($html){
    $result=array();
    if(count($html)>0){
        foreach($html as $i=>$v){
            $result[]='<tr style="vertical-align:top;">';
            $result[]='<td>'.$v.'</td>';
            $result[]='</tr>';
        }
    }
    return implode('',$result);
}
function boletin_grupo_my_no_recibir_form(){
    global $user;
    //
    $is_activo=is_activo_boletin_grupo_user(arg(1),$user->uid);
    //
    $form=array();
    $grupo_nid=arg(1);
    $grupo=node_load($grupo_nid);
    $form['grupo_name']['#value']='<h3>'.$grupo->title.'</h3>';    
    hontza_add_form_menu_alerta_user($form);    
    $form['recibir_txek']=array(
      //'#title'=>t('Recibir boletÃ­n del grupo'),
      '#title'=>t('I give permission to receive the Group Bulletin'),
      '#type'=>'checkbox',
      //'#default_value'=>1,
    );
    if($is_activo){
        $form['recibir_txek']['#attributes']=array('checked'=>'checked');
    }
    //hiddens
    $form['my_uid']=array('#type'=>'hidden','#default_value'=>$user->uid);
    $form['my_grupo_nid']=array('#type'=>'hidden','#default_value'=>$grupo_nid);
    //
    $form['boleting_grupo_btn_submit']=array(
  '#type' => 'submit',
  '#value' => t('Save'),
);

$cancel_url='alerta_user/mis_boletines_grupo';
if(isset($_REQUEST['destination']) && !empty($_REQUEST['destination'])){
    $cancel_url=$_REQUEST['destination'];
}


$form['boletin_grupo_volver']=array(
  //'#value' => l(t('Return'),$_REQUEST['destination'],array('attributes'=>array('id'=>'my_volver_alerta_user','class'=>'back_left'))),
  '#value' => l(t('Cancel'),$cancel_url),
);

    return $form;
}
function get_boletin_grupo_array_no_recibir_row($grupo_nid,$uid){
    //print $grupo_nid.'='.$uid.'<BR>';
    if(!empty($grupo_nid) && !empty($uid)){
        $where=array();
        $where[]="bg.grupo_nid=".$grupo_nid;
        $where[]="bg.uid=".$uid;
        //
        $sql="SELECT bg.* FROM {boletin_grupo_array_no_recibir} bg WHERE ".implode(" AND ",$where);
        $res=db_query($sql);
        while($row=db_fetch_object($res)){
            return $row;
        }
    }
    //
    $my_result=new stdClass();
    return $my_result;
}
function is_activo_boletin_grupo_user($grupo_nid,$uid,$is_boletin_report=0){
    if($is_boletin_report){
        return 1;
    }
    $row=get_boletin_grupo_array_no_recibir_row($grupo_nid,$uid);
    if(isset($row->id) && !empty($row->id)){
        return 0;
    }
    return 1;
}
function boletin_grupo_my_no_recibir_form_submit(&$form,&$form_state){
    $values=$form_state['values'];
    $recibir_txek=$values['recibir_txek'];
    //
    if($recibir_txek){
        delete_boletin_grupo_array_no_recir($values['my_grupo_nid'],$values['my_uid']);
    }else{
        insert_boletin_grupo_array_no_recir($values['my_grupo_nid'],$values['my_uid']);
    }
    //gemini-2013
    drupal_goto('alerta_user/mis_boletines_grupo');
}
function delete_boletin_grupo_array_no_recir($grupo_nid,$uid,$is_user=1){
    $where=array();
    $where[]="1";
    $where[]="grupo_nid=".$grupo_nid;
    if($is_user){
        $where[]="uid=".$uid;
    }
    $sql="DELETE FROM boletin_grupo_array_no_recibir WHERE ".implode(" AND ",$where);
    db_query($sql);
}
function insert_boletin_grupo_array_no_recir($grupo_nid,$uid){
   $is_activo=is_activo_boletin_grupo_user($grupo_nid,$uid);
   if($is_activo){
       $sql=sprintf("INSERT INTO boletin_grupo_array_no_recibir(grupo_nid,uid) VALUES(%d,%d)",$grupo_nid,$uid);
       db_query($sql);
   }
}
function get_value_no_recibir($r){
    global $user;
    //print $r->nid;exit();
    $is_activo=is_activo_boletin_grupo_user($r->nid, $user->uid);
    if($is_activo){
        return t('Yes');
    }
    return t('No');
}
function get_label_frecuencia($frecuencia){
    $options=get_frecuencia_options();
    if(isset($options[$frecuencia]) && !empty($options[$frecuencia])){
        return $options[$frecuencia];
    }
    return $frecuencia;
}
function boletin_grupo_my_delete_form(){
    $form=array();
    //$form['#attributes'] = array('enctype' => "multipart/form-data");

    $row=get_boletin_grupo_row(arg(1));
//echo '-----'.print_r($row,1);exit();
    if(isset($row->id) && !empty($row->id)){
        $form['my_id']=array(
            '#type'=>'hidden',
            '#default_value' =>$row->id,
        );
    }

    $form['grupo_nid']=array(
            '#type'=>'hidden',
            '#default_value' =>arg(1),
        );

$form['frase']=array(
  '#value' => '<p>'.t('Confirm delete Group Bulletin').'</p>',
);


$form['boleting_grupo_btn_submit']=array(
  '#type' => 'submit',
  '#value' => t('Delete'),
);

$form['boletin_grupo_volver']=array(
  //'#value' => l(t('Return'),$_REQUEST['destination'],array('attributes'=>array('id'=>'my_volver_alerta_user','class'=>'back_left'))),
  '#value' => l(t('Cancel'),$_REQUEST['destination']),

);


return $form;
}
function boletin_grupo_my_delete_form_submit(&$form, &$form_state){
    /*
    //global $user;
    $values=$form_state['values'];    
    //
    $row=get_boletin_grupo_row($values['grupo_nid']);
    //
    if(isset($values['my_id']) && !empty($values['my_id']) && is_numeric($values['my_id'])){
        my_delete_boletin_grupo_usuarios($values['my_id']);
        delete_boletin_grupo_array_no_recir($values['grupo_nid'],'',0);
        delete_boletin_grupo_array_today($values['my_id']);
        //
        $sql='DELETE FROM boletin_grupo_array WHERE id='.$values['my_id'];
        db_query($sql);
    }
     */
}
function delete_boletin_grupo_array_today($boletin_grupo_array_id){
     $sql='DELETE FROM boletin_grupo_array_today WHERE boletin_grupo_array_id='.$boletin_grupo_array_id;
     db_query($sql);
}
function is_activado_boletin_grupo_by_row($row,$default_value=1){
    $is_activado=$default_value;
    if(isset($row->id) && !empty($row->id)){
        $is_activado=0;
        if(isset($row->activado) && !empty($row->activado)){
            $is_activado=$row->activado;
        }
    }
    return $is_activado;
}
function get_icono_activado_by_row($row,$es_grande=0){
    $is_activado=is_activado_boletin_grupo_by_row($row,0);
    if($is_activado){
        if($es_grande){
            //intelsat-2015
            //return my_get_icono_action('active48', t('Active'));
            if(isset($row->boletin_report_array_id)){
                return my_get_icono_action('boletin_personalizado32', t('Active'));
            }else{            
                return my_get_icono_action('boletin_grupo32', t('Active'));
            }    
        }else{
            //intelsat-2015
            //return my_get_icono_action('active', t('Active'));
            if(isset($row->boletin_report_array_id)){
                return my_get_icono_action('boletin_personalizado_active', t('Active'));
            }else{
                return my_get_icono_action('boletin_grupo_active', t('Active'));
            }    
        }
    }
    //
    if($es_grande){
        return my_get_icono_action('no_active48', t('No active'));
    }else{
        return my_get_icono_action('no_active', t('No active'));
    }
}
function is_permiso_editar_boletin_grupo($nid){
    //print 'nid='.$nid;
    /*if(empty($nid)){
        return 1;
    }*/
    return is_permiso_gestion_boletin_grupo($nid,1,'',1);
}
function permiso_introduccion_despedida_access(){
        $my_grupo=og_get_group_context();
        if(!empty($my_grupo) && isset($my_grupo->nid) && !empty($my_grupo->nid)){
            $grupo_nid=$my_grupo->nid;
            //if(!is_permiso_gestion_boletin_grupo($grupo_nid,1,'',1)){
            if(!is_permiso_gestion_boletin_grupo($grupo_nid)){
                drupal_access_denied();
                exit();
            }
        }   
}
function boletin_grupo_define_max_limite_resumen(){
    $result=175;
    //$result=alerta_define_max_limite_resumen();
    return $result;
}
function boletin_grupo_define_max_limite_resumen_comentario(){
    $result=175;
    //$result=boletin_grupo_define_max_limite_resumen();
    //$result=alerta_define_max_limite_resumen_comentario();
    return $result;
}
function boletin_grupo_my_edit_form_validate(&$form, &$form_state) {
    $is_bg=1;
    //alerta_limite_resumen_validate($is_bg,$form,$form_state);
    alerta_limite_resumen_comentario_validate($is_bg,$form,$form_state);
}
function boletin_grupo_define_table_headers(){
    $headers=array();
    $headers[0]=array('data'=>t('Group'),'field'=>'title');
    $headers[1]=array('data'=>t('Method'),'field'=>'send_method');
    $headers[2]=array('data'=>t('Frequency'),'field'=>'frecuencia');
    $headers[3]=array('data'=>t('Time'),'field'=>'hora');
    $headers[4]=array('data'=>t('Creation date'),'field'=>'created');
    //$headers[5]=array('data'=>t('I wish to receive'));
    $headers[5]=t('Status');
    //intelsat-2015
    $headers[6]=t('Archive');
    //
    $headers[7]=t('Actions');
    //gemini-2014
    unset($headers[1]);
    unset($headers[4]);
    $headers=array_values($headers);
    //
    return $headers;
}
//intelsat-2015
function boletin_grupo_is_boletin_grupo(){
    $param0=arg(0);
    if(!empty($param0)){    
        if(strcmp($param0,'boletin_grupo')==0){
            return 1;
        }
        if(strcmp($param0,'alerta_user')==0){
            $param1=arg(1);
            if(!empty($param1) && $param1=='mis_boletines_grupo'){
                return 1;
            }    
        }
    }    
    return 0;
}
//intelsat-2015
function boletin_grupo_get_title_simbolo_img($title){
   $result=my_get_icono_action('boletin_grupo32', $title,'boletin_grupo32');
   return $result; 
}
//intelsat-2015
function boletin_grupo_get_boletin_grupo_block(){
    //intelsat-2015
    $html=array();
    if(hontza_canal_rss_is_usuario_basico()){
        return '';
    }
    $html[]='<div class="block block-hontza block-odd region-odd clearfix " id="block-hontza-boletin-grupo-left">';
    //intelsat-2015
    $title=t('Group Bulletin');
    $icono=my_get_icono_action('boletin_grupo_dashboard',$title,'boletin_grupo_dashboard').'&nbsp;';
    //
    $html[]='<h3 class="title">'.$icono.$title.'</h3>';
    $html[]='<div class="content">';
    $html[]=boletin_grupo_get_boletin_grupo_block_links();
    $html[]='</div>';
    $html[]='</div>';
    return implode('',$html); 
}
//intelsat-2015
function boletin_grupo_get_boletin_grupo_block_links(){ 
    $html=array();
    $html[]=l(t('Group Bulletin'),'alerta_user/mis_boletines_grupo');    
    return implode('',$html); 
}
//intelsat-2015
function boletin_grupo_historico_callback(){
    $title=t('Archive');
    drupal_set_title($title);
    $output=create_menu_alerta_user();
    $output.=boletin_grupo_historico_table();    
    return $output;
}
//intelsat-2015
function boletin_grupo_historico_table(){
    $my_limit=32;
    $headers=boletin_grupo_define_historico_table_headers();
    $rows=array();
    $kont=0;
    $grupo_nid=arg(1);
    //
    $where=array();
    $where[]='1';
    $fecha_ini=date('Y-m-d', strtotime('-31 days'));
    $fecha_ini.=' 00:00:00';
    $where[]='boletin_grupo_array_today.fecha>="'.$fecha_ini.'"';
    $where[]='boletin_grupo_array.grupo_nid='.$grupo_nid;
    //intelsat-2015
    //$order_by=' ORDER BY boletin_grupo_array_today.id ASC';
    $order_by=' ORDER BY boletin_grupo_array_today.fecha DESC,boletin_grupo_array_today.id DESC';
    $sql='SELECT boletin_grupo_array_today.*,boletin_grupo_array.grupo_nid 
    FROM {boletin_grupo_array_today} 
    LEFT JOIN {boletin_grupo_array} ON boletin_grupo_array_today.boletin_grupo_array_id=boletin_grupo_array.id 
    WHERE '.implode(' AND ',$where).$order_by;    
    $res=db_query($sql);
    while($r=db_fetch_object($res)){
      $node=node_load($r->grupo_nid);
      $rows[$kont][0]=$node->title;
      $rows[$kont][1]=boletin_grupo_get_fecha_sended_date($r);
      $rows[$kont][2]=boletin_grupo_get_acciones_historico($r);
      $kont++;
    }
    $rows=my_set_estrategia_pager($rows, $my_limit);

  if (count($rows)>0) {
    /*$feed_url = url('idea_rss.xml', array('absolute' => TRUE));
    drupal_add_feed($feed_url, variable_get('site_name', 'Drupal') . ' ' . t('RSS'));*/
    $output .= theme('table',$headers,$rows);
    $output .= theme('pager', NULL, $my_limit);
  }
  else {

    $output.= '<div id="first-time">' .t('There are no contents'). '</div>';
  }
  //intelsat-2015
  $icono=my_get_icono_action('back_cancel',t('Back')).'&nbsp;';
  $url_volver='alerta_user/mis_boletines_grupo';
  $url_volver=hontza_canal_rss_get_alerta_user_volver_url($url_volver);
  $output.=l($icono.t('Back'),$url_volver,array('html'=>TRUE));
  //
  return $output;
}
//intelsat-2015
function boletin_grupo_define_historico_table_headers(){
    $result=boletin_report_define_historico_table_headers();
    //unset($result[2]);
    $result=array_values($result);
    return $result;
}
//intelsat-2015
function boletin_grupo_get_fecha_sended_date($r){
    if(isset($r->fecha_send) && !empty($r->fecha_send)){
        return date('Y-m-d H:i',$r->fecha_send);
    }
    $time=strtotime($r->fecha);
    return date('Y-m-d',$time);
}
//intelsat-2015
function boletin_grupo_get_acciones_historico($r,$destination_in='',$only_view=0){
    $html=array();
    $grupo_nid=arg(1);
    if(!empty($destination_in)){
        $destination=$destination_in;
    }else{    
        $destination='destination=boletin_grupo/'.$grupo_nid.'/historico';
    }
    $html[]=l(my_get_icono_action('viewmag', t('Web')),'boletin_grupo/'.$grupo_nid.'/my_web_historico/'.$r->id,array('query'=>$destination,'attributes'=>array('target'=>'_blank','title'=>t('Web'),'alt'=>t('Web')),'html'=>true));    
    if(!$only_view){
        $html[]=l(my_get_icono_action('download_manager', t('Download html')),'boletin_grupo/'.$grupo_nid.'/download_html/'.$r->id,array('query'=>$destination,'attributes'=>array('target'=>'_blank','title'=>t('Download html'),'alt'=>t('Download html')),'html'=>true));        
        $html[]=l(my_get_icono_action('forward', t('Forward Bulletin')),'boletin_grupo/'.$grupo_nid.'/forward/'.$r->id,array('query'=>$destination,'attributes'=>array('title'=>t('Forward Bulletin'),'alt'=>t('Forward Bulletin')),'html'=>true));            
    }
    if(is_super_admin()){
        $html[]=l(my_get_icono_action('pdf',t('Pdf')),'boletin_grupo/'.$grupo_nid.'/pdf/'.$r->id,array('query'=>$destination,'attributes'=>array('target'=>'_blank','title'=>t('Pdf'),'alt'=>t('Pdf')),'html'=>true));        
    }
    //return add_div_actions(implode('&nbsp;',$html));
    return implode('&nbsp;',$html);
}
//intelsat-2015
function boletin_grupo_my_web_historico_callback(){
    $is_pdf=boletin_report_pdf_is_pdf();
    $is_print_exit=1;
    $volver='';
    if($is_pdf){
        $is_print_exit=0;
    }else{
        $volver=l(t('Return'),$_REQUEST['destination'],array('attributes'=>array('class'=>'back_left')));
    }
    $content=boletin_grupo_get_content_html(0,$is_print_exit);
    //
    $content=$volver.$content;
    return $content;
}
//intelsat-2015
function boletin_grupo_get_boletin_grupo_array_today_row($boletin_grupo_array_today_id){
    $boletin_grupo_array_today=boletin_grupo_get_boletin_grupo_array_today($boletin_grupo_array_today_id);
    if(!empty($boletin_grupo_array_today)){
        return $boletin_grupo_array_today[0];
    }
    //
    $my_result=new stdClass();
    return $my_result;
}
//intelsat-2015
function boletin_grupo_get_boletin_grupo_array_today($boletin_grupo_array_today_id='',$is_last=0,$grupo_nid=''){
    $result=array();
    $where=array();
    $where[]='1';
    $order_by='';
    if(!empty($boletin_grupo_array_today_id)){
        $where[]='boletin_grupo_array_today.id='.$boletin_grupo_array_today_id;
    }
    if(!empty($grupo_nid)){
        $where[]='boletin_grupo_array.grupo_nid='.$grupo_nid;
    }
    if($is_last){
        $order_by=' ORDER BY boletin_grupo_array_today.fecha DESC';
    }
    $sql='SELECT boletin_grupo_array_today.*,boletin_grupo_array.grupo_nid,boletin_grupo_array.send_method 
    FROM {boletin_grupo_array_today} 
    LEFT JOIN {boletin_grupo_array} ON boletin_grupo_array_today.boletin_grupo_array_id=boletin_grupo_array.id 
    WHERE '.implode(' AND ',$where).$order_by;
    $res=db_query($sql);
    while($row=db_fetch_object($res)){
        $result[]=$row;
    }
    return $result;
}
//intelsat-2015
function boletin_grupo_get_content_html($is_download=0,$is_print_exit=1,$grupo_nid_in='',$boletin_grupo_array_today_id_in=''){
    if(!empty($grupo_nid_in)){
        $grupo_nid=$grupo_nid_in;
    }else{    
        $grupo_nid=arg(1);
    }
    //
    if(!empty($boletin_grupo_array_today_id_in)){
        $boletin_grupo_array_today_id=$boletin_grupo_array_today_id_in;
    }else{
        $boletin_grupo_array_today_id=arg(3);
    }
    $boletin_grupo_array_today_row=boletin_grupo_get_boletin_grupo_array_today_row($boletin_grupo_array_today_id);
    $content='';
    if(isset($boletin_grupo_array_today_row->texto) && !empty($boletin_grupo_array_today_row->texto)){
        $content=$boletin_grupo_array_today_row->texto;
    }
    //intelsat-2015
    if(red_despacho_is_activado()){
        $content=red_despacho_boletin_report_get_download_content($content,$is_download);
    }
    if($is_print_exit){
        print alerta_add_css($content,$is_download);
        exit();
    }
    $is_pdf=boletin_report_pdf_is_pdf();
    if($is_pdf){
        $content=alerta_add_css($content,$is_download);
        $content=red_despacho_boletin_report_fix_pdf($content);
    }
    return $content;
}
//intelsat-2015
function boletin_grupo_download_html_callback(){
    $grupo_nid=arg(1);
    $boletin_grupo_array_today_id=arg(3);            
    $filename='bulletin_'.$grupo_nid.'_'.$boletin_grupo_array_today_id.'.html';
    header('Content-type: text/xml');
    header('Content-Disposition: attachment; filename="'.$filename.'"');
    boletin_grupo_get_content_html(1);
}
//intelsat-2015
function boletin_grupo_forward_callback(){
    $is_download=0;
    $is_print_exit=0;
    $content=boletin_grupo_get_content_html($is_download,$is_print_exit);
    $html=drupal_get_form('boletin_grupo_forward_form');
    $html.=red_despacho_boletin_report_get_boletin_report_forward_content_view_web($content);
    return $html;
}
//intelsat-2015
function boletin_grupo_pdf_access(){
    if(is_super_admin()){
        return TRUE;
    }
    return FALSE;
}
//intelsat-2015
function boletin_grupo_pdf_callback(){
    $content=boletin_grupo_get_content_html(0,0);
    boletin_report_pdf_create_pdf($content);
}
//intelsat-2015
function boletin_grupo_forward_form(){
    $form=array();
    $grupo_nid=arg(1);
    $boletin_grupo_array_today_id=arg(3);                
    $form['grupo_nid']=array(
        '#type'=>'hidden',
        '#default_value'=>$grupo_nid,
    );
    $form['boletin_grupo_array_today_id']=array(
        '#type'=>'hidden',
        '#default_value'=>$boletin_grupo_array_today_id,
    );
    $form['forward_receptores_fs']['email_externos'] = array(
          '#type' => 'textarea',
          '#title' => t('External recipients'),
          //'#default_value' => '',
          '#description'=>t('Please include the email of recipients separated by commas')." (".t("Please verify your email list, It won't be checked the validity of emails").")",  
          '#required' => FALSE
          );
    $form['forward_btn']=array(
        '#type'=>'submit',
        '#name'=>'forward_btn',
        '#default_value'=>t('Forward Bulletin'),
    );
    $form['cancel_btn']=array(
        '#value'=>l(t('Cancel'),'boletin_grupo/'.$grupo_nid.'/historico')
    );
    return $form;
}
//intelsat-2015
function boletin_grupo_get_ultimo_boletin_grupo_content(){
    $boletin_grupo_array_today_ultimo_row=boletin_grupo_get_boletin_grupo_array_today_ultimo_row();
    if(isset($boletin_grupo_array_today_ultimo_row->id) && !empty($boletin_grupo_array_today_ultimo_row->id)){
        if(isset($boletin_grupo_array_today_ultimo_row->texto) && !empty($boletin_grupo_array_today_ultimo_row->texto)){
            $grupo_node=node_load($boletin_grupo_array_today_ultimo_row->grupo_nid);
            if(isset($grupo_node->nid) && !empty($grupo_node->nid)){
                //$title=$grupo_node->title;
                $title=t('Group Bulletin');
                $last=' views-row-first';
                $odd='odd';
                $kont=1;
                $html[]='<div class="views-row views-row-'.$kont.' views-row-'.$odd.$last.'">';
                $html[]='<div class="views-field-title">';
                $html[]='<span class="field-content">';
                $html[]=my_get_icono_action('boletin_grupo_dashboard', t('Group Bulletin')).l($title,'boletin_grupo/'.$boletin_grupo_array_today_ultimo_row->grupo_nid.'/my_web_historico/'.$boletin_grupo_array_today_ultimo_row->id,array('attributes'=>array('target'=>'_blank')));
                $html[]='</span>';
                $html[]='</div>';
                $html[]='</div>';
                return implode('',$html);
            }    
        }
    }
    return '';
}
//intelsat-2015
function boletin_grupo_get_boletin_grupo_array_today_ultimo_row(){
    $my_grupo=og_get_group_context();
    if(isset($my_grupo->nid) && !empty($my_grupo->nid)){
        $grupo_nid=$my_grupo->nid;
        $boletin_grupo_array_today=boletin_grupo_get_boletin_grupo_array_today('',1,$grupo_nid);
        if(count($boletin_grupo_array_today>0)){
            return $boletin_grupo_array_today[0];
        }
    }        
    $my_result=new stdClass();
    return $my_result;
}
//intelsat-2015
function boletin_grupo_forward_form_submit(&$form, &$form_state){
    global $user;
    if(isset($form_state['clicked_button']) && !empty($form_state['clicked_button']) && $form_state['clicked_button']['#name']=='forward_btn'){        
        //
        $values=$form_state['values'];
        $grupo_nid=$values['grupo_nid'];
        $boletin_grupo_array_today_id=$values['boletin_grupo_array_today_id'];
        $email_externos=$values['email_externos'];
        boletin_grupo_forward_loop($grupo_nid,$boletin_grupo_array_today_id,$email_externos);
        $uid=$user->uid;
        $fecha_forward=date('Y-m-d H:i:s');
        $boletin_grupo_array_id=boletin_grupo_get_boletin_grupo_array_id($boletin_grupo_array_today_id);
        db_query('INSERT INTO {boletin_grupo_array_forward}(boletin_grupo_array_id,boletin_grupo_array_today_id,email_externos,uid,fecha_forward) VALUES(%d,%d,"%s",%d,"%s")',$boletin_grupo_array_id,$boletin_grupo_array_today_id,$email_externos,$uid,$fecha_forward);
        //drupal_goto('boletin_grupo/'.$grupo_nid.'/historico');
    }
}
//intelsat-2015
function boletin_grupo_forward_loop($grupo_nid,$boletin_grupo_array_today_id,$email_externos){
    $row=boletin_grupo_get_boletin_grupo_array_today_row($boletin_grupo_array_today_id);
    if(isset($row->id) && !empty($row->id)){
        $title='';
        $grupo_node=node_load($row->grupo_nid);
        if(isset($grupo_node->nid) && !empty($grupo_node->nid)){    
            $title=': '.$grupo_node->title;
        }
        $subject=t('Group Bulletin').$title;                
        $is_download=0;
        $is_print_exit=0;
        $content=boletin_grupo_get_content_html($is_download,$is_print_exit,$grupo_nid,$boletin_grupo_array_today_id);
        $mail_html=alerta_add_css($content,0);
        $user_mail_array=explode(',',$email_externos);
        if(count($user_mail_array)>0){
            foreach($user_mail_array as $i=>$user_mail){
                $is_activo=1;
                $current_content=$mail_html;
                my_send_mail($user_mail,$subject,$current_content,$row->send_method,$is_activo);                  
            }
        }
    }
}
//intelsat-2015
function boletin_grupo_get_boletin_grupo_array_id($boletin_grupo_array_today_id){
    $row=boletin_grupo_get_boletin_grupo_array_today_row($boletin_grupo_array_today_id);
    if(isset($row->boletin_grupo_array_id) && !empty($row->boletin_grupo_array_id)){
        return $row->boletin_grupo_array_id;
    }
    return 0;
}
//intelsat-2016
function boletin_grupo_custom_access(){
    if(user_access('view customised bulletin resume')){
        return TRUE;
    }
    return FALSE;
}    