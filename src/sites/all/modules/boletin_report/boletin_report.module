<?php
require_once('boletin_report.inc.php');
require_once('boletin_report.pdf.inc.php');
require_once('boletin_report.todos.inc.php');
//intelsat-2016
require_once('boletin_report.mcapi.inc.php');
function boletin_report_perm() {
  return array('access boletin report','edit customised bulletin','view customised bulletin resume','report content','Launch Customised Bulletin','view customised bulletin pdf');
}
function boletin_report_menu() {
  $items['boletin_report/list'] = array(
    'title' => 'Customised Bulletins',
    'page callback' => 'boletin_report_list',
    'access arguments' => array('access boletin report'),
  );

  $items['boletin_report/add'] = array(
    'title' => 'Create Customised Bulletin',
    'page callback' => 'drupal_get_form',
    'page arguments'   => array('boletin_report_form'),
    'access arguments' => array('edit customised bulletin'),
  );
  
   $items['boletin_report/%/edit'] = array(
    'title' => 'Edit Customised Bulletin',
    'page callback' => 'drupal_get_form',
    'page arguments'   => array('boletin_report_form'),
    'access arguments' => array('edit customised bulletin'),
  );
   
   $items['boletin_report/%/delete'] = array(
    'title' => 'Delete Customised Bulletin',
    'page callback' => 'drupal_get_form',
    'page arguments'   => array('boletin_report_delete_form'),
    'access arguments' => array('edit customised bulletin'),
  );
   
   $items['boletin_report/%/my_web'] = array(
    'title' => t('View Customised Bulletin on the web'),
    'page callback' => 'boletin_report_web_callback',
    'access arguments' => array('view customised bulletin resume'),
  );
   
   $items['boletin_report/%/report'] = array(
    'title' => 'Include in the Bulletin?',
    'page callback' => 'drupal_get_form',
    'page arguments'   => array('boletin_report_yes_form'),
    'access arguments' => array('report content'),
  );
   
   $items['boletin_report/%/no_report'] = array(
    'title' => 'Exclude from the Bulletin?',
    'page callback' => 'drupal_get_form',
    'page arguments'   => array('boletin_report_no_form'),
    'access arguments' => array('report content'),
  );
   
   $items['boletin_report/report_view_list'] = array(
    'title' => 'Reports Area',
    'page callback' => 'boletin_report_view_list',
    'access arguments' => array('access boletin report'),
  );
   
   $items['boletin_report/%/launch'] = array(
    'title' => 'Launch Customised Bulletin',
    /*'page callback' => 'drupal_get_form',
    'page arguments'   => array('boletin_report_launch_form'),*/
    'page callback' => 'boletin_report_launch_callback',
    'access arguments' => array('Launch Customised Bulletin'),
  );
   
   $items['boletin_report/%/report_ajax'] = array(
    'title' => 'Include in the Bulletin?',
    'page callback' => 'boletin_report_ajax_callback',
    'access arguments' => array('report content'),
  );
   
   $items['boletin_report/%/no_report_ajax'] = array(
    'title' => 'Exclude from the Bulletin?',
    'page callback' => 'boletin_report_no_ajax_callback',
    'access arguments' => array('report content'),
  );

  $items['boletin_report/%/historico'] = array(
    'title' => t('Sent Bulletins'),
    'page callback' => 'boletin_report_historico_callback',
    'access arguments' => array('view customised bulletin resume'),
  );
  
  $items['boletin_report/%/reload'] = array(
    'title' => 'Reload Customised Bulletin',
    'page callback' => 'drupal_get_form',
    'page arguments'   => array('boletin_report_reload_form'),
    'access arguments' => array('edit customised bulletin'),
  );
  
   $items['boletin_report/%/download_html'] = array(
    'title' => t('Download Bulletin'),
    'page callback' => 'boletin_report_download_html_callback',
    'access arguments' => array('view customised bulletin resume'),
  );
   
   $items['boletin_report/%/forward'] = array(
    'title' => t('Forward Bulletin'),
    'page callback' => 'boletin_report_forward_callback',
    'access arguments' => array('view customised bulletin resume'),
  );
   
   $items['boletin_report/select_group'] = array(
    'title' => t('Select group'),
    'page callback' => 'drupal_get_form',
    'page arguments'   => array('boletin_report_select_group_form'),
    'access arguments' => array('edit customised bulletin'),
  );
   
    $items['node/%/noticia_boletines'] = array(
    'title'=>t('Bulletins'),
    'page callback' => 'boletin_report_noticia_boletines_callback',
    'access arguments' => array('access boletin report'),
  );    
     $items['boletin_report/%/pdf'] = array(
    'title' => t('View Customised Bulletin on the web'),
    'page callback' => 'boletin_report_pdf_callback',
    'access arguments' => array('view customised bulletin pdf'),
  );     
     $items['boletin_report/pdf_div'] = array(
    'title' => t('View Customised Bulletin on the web'),
    'page callback' => 'boletin_report_pdf_div_callback',
    'access arguments' => array('view customised bulletin pdf'),
  );
    //intelsat-2015 
    $items['boletin_report/report_bookmark/%'] = array(
    'title' => 'Select for the Bulletin',
    'page callback' => 'boletin_report_bookmark_callback',
    'access arguments' => array('report content'),
    );     
    $items['boletin_report/%/pdf_node'] = array(
    'title' => t('Pdf'),
    'page callback' => 'boletin_report_pdf_node_callback',
    'access callback' => 'boletin_report_pdf_node_access',
    );
    $items['boletin_report/%/new_pdf_node'] = array(
    'title' => t('Pdf'),
    'page callback' => 'boletin_report_pdf_new_pdf_node_callback',
    'access callback' => 'boletin_report_pdf_node_access',
    );
    $items['boletin_report/%/view_pdf_node'] = array(
    'title' => t('Pdf'),
    'page callback' => 'boletin_report_pdf_view_pdf_node_callback',
    'access callback' => 'boletin_report_pdf_node_access',
    );
    $items['boletin_report/%/delete_pdf_node'] = array(
    'title' => t('Pdf'),
    'page callback' => 'boletin_report_pdf_delete_pdf_node_callback',
    'access callback' => 'boletin_report_pdf_node_access',
    );
    //intelsat-2015
    $items['boletin_report/%/previsualizacion_boletin'] = array(
    'title' => t('Preview'),
    'page callback' => 'boletin_report_inc_previsualizacion_boletin_callback',
    'access arguments' => array('view customised bulletin resume'),
  );
     $items['boletin_report/historico/todos'] = array(
    'title' => t('Archive'),
    'page callback' => 'boletin_report_historico_todos_callback',
    'access arguments' => array('view customised bulletin resume'),
  );
    //intelsat-2016
    $items['boletin_report/unselect_report_bookmark/%'] = array(
    'title' => 'Unselect from Bulletin',
    'page callback' => 'boletin_report_unselect_report_bookmark_callback',
    'access arguments' => array('report content'),
    ); 
    //     
  return $items;
}
function boletin_report_list(){
    drupal_set_title(t('Customised Bulletins'));
    //boletin_report_no_group_selected_denied();
    $output=create_menu_alerta_user();
    //$output.=my_create_boton_boletin_volver();
    $my_grupo=og_get_group_context();
    $url='boletin_report/select_group';
    //intelsat-2015
    //se ha comentado esto
    /*if(isset($my_grupo->nid) && !empty($my_grupo->nid)){        
        $url='boletin_report/add';
        if(boletin_report_is_permiso_editar($my_grupo->nid)){
            $output.=l(t('Add New Series'),$url,array('attributes'=>array('class'=>'add'))); 
        }    
    }else{
        $select_group_options=boletin_report_get_select_group_options();
        if(!empty($select_group_options)){
            $output.=l(t('Add New Series'),$url,array('attributes'=>array('class'=>'add')));
        }    
    }*/
    
    $output.=boletin_report_table();
    
    return $output;
}
function boletin_report_is_admin(){
    global $user;
    if(is_user_administrador_de_grupo()){
        if(red_is_claves_activado()){
            if(is_administrador_grupo()){
                return 1;
            }
        }else{
            return 1;
        }
    }
    //
    if(isset($user->uid) && !empty($user->uid) && $user->uid==1){
        return 1;
    }
    return 0;
}
function boletin_report_form(){
    $grupo_nid='';
    $id='';
    $my_grupo=og_get_group_context();
    if(isset($my_grupo->nid) && !empty($my_grupo->nid)){
        $grupo_nid=$my_grupo->nid;
    }
    
    //boletin_report_no_group_selected_denied();
    //boletin_report_my_access();
        
    if(boletin_report_is_add()){
        $row=new stdClass();
        //intelsat-2015
        //drupal_set_title(t('Create Customised Bulletin'));
        drupal_set_title(t('Add New Series'));
        /*if(!boletin_report_is_permiso_editar($grupo_nid)){
            drupal_access_denied();
            exit();
        }*/
    }else{
        $id=arg(1);
        $row=boletin_report_get_row($id);
        if(isset($row->grupo_nid) && !empty($row->grupo_nid)){
            $grupo_nid=$row->grupo_nid;
        }
        drupal_set_title(t('Edit Customised Bulletin'));
    }
        
    //echo print_r($row,1);
    //if(!is_permiso_editar_boletin_grupo($row->grupo_nid)){
    //if(!boletin_report_is_permiso_gestion($grupo_nid,1,'',1)){
    /*if(!boletin_report_is_permiso_editar($grupo_nid)){
        drupal_access_denied();
        exit();
    }*/
    boletin_report_my_access($grupo_nid);
   
    
    $node_grupo=node_load($grupo_nid);
    $grupo_title='';
    if(isset($node_grupo->nid) && !empty($node_grupo->nid)){
        $grupo_title=$node_grupo->title;
    }

    $form=array();
    $form['#attributes'] = array('enctype' => "multipart/form-data");

    
//echo '-----'.print_r($row,1);exit();
    if(isset($row->id) && !empty($row->id)){
        $form['my_id']=array(
            '#type'=>'hidden',
            '#default_value' =>$row->id,
        );
    }

    $form['grupo_nid']=array(
            '#type'=>'hidden',
            '#default_value' =>$grupo_nid,
        );

$form['activado48']=array(
            '#value' =>get_icono_activado_by_row($row,1),
        );
    
    
        
    $form['titulo']=array(
        '#type'=>'textfield',
        '#title'=>t('Serie'),
        '#default_value'=>$row->titulo,
        '#required' => TRUE
    );
    
    $form['grupo_title']=array(
        '#type'=>'textfield',
        '#title'=>t('Group'),
        '#default_value'=>$grupo_title,
        '#attributes' => array('readonly' => 'readonly')
    );
    
    $form['boletin_report_receptores_fs']=array(
    '#type'=>'fieldset',
    '#title'=>t('Recipients of Customised Bulletin'),
    '#collapsible'=>TRUE,
    '#attributes'=>array('id'=>'id_boletin_report_receptores_fs'),    
);
    
    $form['boletin_report_receptores_fs']['is_todos_usuarios']=array(
              '#type'=>'checkbox',
              '#title'=>t('All users'),
            );
            if((isset($row->is_todos_usuarios) && !empty($row->is_todos_usuarios)) || !isset($row->is_todos_usuarios)){
                $form['boletin_report_receptores_fs']['is_todos_usuarios']['#attributes']=array('checked'=>'checked');
            }


        $form['boletin_report_receptores_fs']['usuarios'] = array(
          '#type' => 'select',
          '#title' => t('Users'),
          '#default_value' => $row->usuarios,
          '#options'=>boletin_report_get_usuarios_options($grupo_nid),
          '#multiple'=>TRUE,
          '#size'=>20,
          '#required' => FALSE,
          //intelsat-2015  
          '#prefix'=>'<div style="float:left;clear:both;"><div style="float:left;width:25%;">',
          '#suffix'=>'</div>',  
          );
        
        $form['boletin_report_receptores_fs']['email_externos'] = array(
          '#type' => 'textarea',
          '#title' => t('External recipients'),
          '#default_value' => $row->email_externos_value,
          '#description'=>t('Please include the email of recipients separated by commas')." (".t("Please verify your email list, It won't be checked the validity of emails").")",  
          '#required' => FALSE,
          //intelsat-2015
          '#rows'=>19,  
          '#prefix'=>'<div style="float:left;width:70%">',    
          '#suffix'=>'</div></div>',  
          );

        //intelsat-2016
        boletin_report_mcapi_add_boletin_report_form_fields($row,$form);
        
        $form['categorias_fs']=boletin_report_create_categorias_fieldset_txek($row,$grupo_nid);
        //intelsat-2015
        red_despacho_boletin_report_add_tipos_fuente_fieldset($row,$form);
        
        $limites_fs=boletin_report_create_limites_fieldset($row);
        $form['contenidos_fs']=boletin_report_create_contenidos_fieldset_txek($row,$limites_fs);
        $form['limites_fs']=$limites_fs;
    
    $form['metodo_fs']=array(
    '#type'=>'fieldset',
    '#title'=>t('Others'),
    '#collapsible'=>TRUE,
    '#attributes'=>array('id'=>'id_boletin_report_others_fs'),     
);

$form['metodo_fs']['activado'] = array(
        '#type' => 'checkbox',
        '#title' => t('Active'),
        //'#value' => 1,
        //'#required' => TRUE
      );

//
if(is_activado_boletin_grupo_by_row($row)){
    $form['metodo_fs']['activado']['#attributes']=array('checked'=>'checked');
}
//

$form['metodo_fs']['is_editable'] = array(
        '#type' => 'checkbox',
        '#title' => t('Editable'),
      );

//
if(empty($id) || boletin_report_is_editable_by_row($row)){
    //intelsat-2015
    if(red_despacho_is_activado()){
        $form['metodo_fs']['is_editable']['#prefix']='<div style="display:none">';
        $form['metodo_fs']['is_editable']['#suffix']='</div>';
    }else{    
        $form['metodo_fs']['is_editable']['#attributes']=array('checked'=>'checked');
    }    
}
//

        
$form['metodo_fs']['send_method'] = array(
        '#type' => 'select',
        '#title' => t('Select Sending Method'),
        '#options' => my_get_methods(),
        '#default_value' => $row->send_method,
        //'#required' => TRUE
         //intelsat-2015
        '#prefix'=>'<div style="display:none;">',
        '#suffix'=>'</div>',
        //
      );

if(hontza_canal_rss_is_publico_activado()){
     publico_alerta_add_is_boletin_publico_form_field($form,$row);
}
//intelsat-2016
$tipo_link=red_despacho_boletin_report_get_tipo_link_default_value($row);
$form['metodo_fs']['tipo_link'] = array(
        '#type' => 'select',
        '#title' => t('Links'),
        '#options' => boletin_report_get_tipo_link_options(),
        '#default_value' =>$tipo_link,
        //'#required' => TRUE
      );

$form['boleting_report_btn_submit']=array(
  '#type' => 'submit',
  '#name'=>'boleting_report_btn_submit',  
  '#value' => t('Save'),
  '#prefix'=>'<div id="id_boletin_report_buttons">',  
);        


    $form['boletin_report_volver']=array(
  '#value' => l(t('Cancel'),'boletin_report/list',array('attributes'=>array('id'=>'id_boletin_report_volver'))),
  '#suffix'=>'</div>',      
);
return $form;
}
function boletin_report_is_add(){
    $param0=arg(0);
    if(!empty($param0) && $param0=='boletin_report'){
        $param1=arg(1);
        if(!empty($param1) && $param1=='add'){
            $param2=arg(2);
            if(empty($param2)){
                return 1;
            }
        }
    }
    return 0;
}
function boletin_report_get_row($id){
    if(!empty($id) && is_numeric($id)){
        $boletin_report_list=boletin_report_get_list($id);
        if(count($boletin_report_list)>0){
            return $boletin_report_list[0];
        }
    }
    //
    $my_result=new stdClass();
    return $my_result;
}
function boletin_report_get_usuarios_options($grupo_nid_in=''){
    $result=array();
    
    if(empty($grupo_nid_in)){    
        $my_grupo=og_get_group_context();
        if(isset($my_grupo->nid) && !empty($my_grupo->nid)){
            $grupo_nid=$my_grupo->nid;
        }
    }else{
        $grupo_nid=$grupo_nid_in;
    }    
    
    return get_usuarios_grupo_options($grupo_nid);
            
    //return $result;        
}
function boletin_report_create_contenidos_fieldset_txek($row,&$limites_fs){
    $result=array();
    $result['contenidos_fs']=array(
    '#type'=>'fieldset',
    '#title'=>t('Contents'),
    '#collapsible'=>TRUE,
    '#attributes'=>array('id'=>'id_boletin_report_contenidos_fs'),    
);
    /*
    //intelsat-2015
    if(boletin_report_inc_is_orden_content_activado()){
        $result['contenidos_orden_fs']=array(
        '#type'=>'fieldset',
        '#title'=>t('Contents Order'),
        '#collapsible'=>TRUE,
        '#attributes'=>array('id'=>'id_boletin_report_contenidos_orden_fs'),    
        );
    } 
    //
     */ 
    //
    $my_array=boletin_report_create_contenido_fields();
    //intelsat-2015
    $num=count($my_array);
    //
    foreach($my_array as $i=>$field){
        //intelsat-2015
        $label=$field['label'];
        if($field['name']=='is_todos_items'){
            $label=t('News and User News');
        }else if($field['name']=='is_todos_noticias_usuario'){
            continue;
        }
        //
        $result['contenidos_fs'][$field['name']]=array(
              '#type'=>'checkbox',
              '#title'=>$label,
              //'#attributes'=>array('style'=>'float:left;'),  
            );
        
        //intelsat-2015
        $display=boletin_report_inc_get_display_contents($field['name']);                
        if(boletin_report_inc_is_orden_content_activado()){
            $result['contenidos_fs'][$field['name']]['#prefix']='<div style="clear:both;float:left;width:100%;'.$display.'"><div style="float:left;width:28%;margin-top:-5px;">';
            $result['contenidos_fs'][$field['name']]['#suffix']='</div>';
        }
        //
         
        
        $f=$field['name'];
        
        //intelsat-2015
        if(boletin_report_inc_is_orden_content_activado()){
            $padding_bottom=0;
            if($i==($num-1)){
                $padding_bottom=10;
            }
            $orden_name=$f.'_orden';
            //$orden_value=0;
            $orden_value=1;
            if(isset($row->$orden_name) && !empty($row->$orden_name)){
                $orden_value=$row->$orden_name;
            }else{
                $orden_value=boletin_report_inc_get_orden_value_default($f);
            }
            /*$label_orden=$field['label'];
            if($orden_name=='is_todos_items_orden'){
                $label_orden=t('News and User News');
            }*/
            $label_orden=t('Order');
            if($orden_name!='is_todos_noticias_usuario_orden'){
                //$result['contenidos_orden_fs'][$orden_name]=array(
                $result['contenidos_fs'][$orden_name]=array(
                            //'#type'=>'textfield',
                            '#type'=>'select',
                            '#title'=>$label_orden,
                            '#options'=>boletin_report_inc_define_orden_options(),
                            '#default_value'=>$orden_value,
                            '#prefix'=>'<div style="float:left;padding-left:10px;padding-bottom:'.$padding_bottom.'px;width:15%;">',
                            '#suffix'=>'</div>',
                            //'#attributes'=>array('style'=>'float:left;width:100px;'),
                            //'#attributes'=>array('style'=>'width:100px;'),
                            '#attributes'=>array('style'=>'float:left;'),
                        );
                //
                $limite_name=str_replace('is_','limite_',$field['name']);
                $result['contenidos_fs'][$limite_name]=$limites_fs[$limite_name];
                $result['contenidos_fs'][$limite_name]['#prefix']='<div style="float:left;padding-left:10px;padding-bottom:'.$padding_bottom.'px;width:52%;">';
                $result['contenidos_fs'][$limite_name]['#suffix']='</div></div>';
                unset($limites_fs[$limite_name]);
            }
        }
        //
       // print $f.'<BR>';
        if((isset($row->$f) && !empty($row->$f)) || !isset($row->$f)){
            //intelsat-2015
            if(red_despacho_boletin_report_is_content_field_checked($f)){
                $result['contenidos_fs'][$f]['#attributes']=array('checked'=>'checked');
            }  
        }
    }
    //
    return $result;
}
function boletin_report_create_contenido_fields(){
    $my_array=array();
    //
    $my_array[0]['name']='is_todos_items';
    $my_array[0]['label']=t('News');
    //
    $my_array[1]['name']='is_todos_noticias_usuario';
    $my_array[1]['label']=t('User News');
    //
    $my_array[2]['name']='is_todos_debates';
    $my_array[2]['label']=t('Discussions');
    //
    $my_array[3]['name']='is_todos_wikis';
    $my_array[3]['label']=t('Collaborations');
    //
    $my_array[4]['name']='is_todos_reports';
    $my_array[4]['label']=t('Reports');    
    return $my_array;
}
function boletin_report_create_limites_fieldset($row){
    $result=array();
    //intelsat-2015
    $text_attributes=array('style'=>'width:50px;margin-left:5px;');
    //    
    $result['limites_fs']=array(
    '#type'=>'fieldset',
    '#title'=>t('Limits'),
    '#collapsible'=>TRUE,
    '#attributes'=>array('id'=>'id_boletin_report_limites_fs'),      
);
     //
    $my_array=boletin_report_create_contenido_fields();
    //
    foreach($my_array as $i=>$field){
        if($field['name']=='is_todos_noticias_usuario'){
            continue;
        }
        $name=str_replace('is_','limite_',$field['name']);
        //intelsat-2015
        /*$limite_label=t('Limit of').' '.$field['label'];
        if($field['name']=='items'){
            $limite_label=t('Limit of').' '.t('News and User News');
        }*/
        $limite_label=t('Limit');
        //intelsat-2016
        //intelsat-2016
        $limite_default_value=red_despacho_boletin_report_get_limite_default_value($row,$name,$field['name']);
        //
        $result['limites_fs'][$name]=array(
              '#type'=>'textfield',
              '#title'=>$limite_label,
              //intelsat-2015
              '#attributes'=>array('style'=>'margin-left:5px;'),  
              //  
              //'#default_value'=>get_alerta_my_limite($row->$name),
              '#default_value'=>$limite_default_value,
            );        
    }
    
    $result['limites_fs']['apply_limite_resumen']=array(
              '#type'=>'checkbox',
              //'#title'=>t('Limit Abstract length'),
              //intelsat-2015  
              '#prefix'=>'<div style="float:left;clear:both;width:100%;"><div style="float:left;width:3%;margin-top:-5px;">',
              '#suffix'=>'</div>',            
            );
            if((isset($row->apply_limite_resumen) && !empty($row->apply_limite_resumen)) || !isset($row->id)){
                $result['limites_fs']['apply_limite_resumen']['#attributes']=array('checked'=>'checked');
            }
            
    $limite_resumen=red_despacho_boletin_report_get_limite_resumen($row); 
    $result['limites_fs']['limite_resumen']=array(
              '#type'=>'textfield',
              //'#title'=>t('Abstract Length'),
              '#title'=>t('Limit abstract length to'),
              //'#default_value'=>get_alerta_my_limite($row->limite_resumen,boletin_grupo_define_max_limite_resumen()),
              '#default_value'=>$limite_resumen,
              //'#required' => TRUE,
              //intelsat-2015  
              '#prefix'=>'<div style="float:left;padding-left:10px;">',
              '#suffix'=>'</div>',
              '#attributes'=>$text_attributes,
            );
    //intelsat-2015
    $caracteres_html='<div style="float:left;padding-left:5px;padding-top:19px;"><b>'.t('characters').'</b></div></div>';
    $result['limites_fs']['limite_resumen_label_caracteres']=array(
        '#value'=>$caracteres_html,
    );    
    //
    //intelsat-2015
    $display=red_despacho_boletin_report_get_limit_comments_length_display();    
    $result['limites_fs']['apply_limite_resumen_comentario']=array(
              '#type'=>'checkbox',
              //'#title'=>t('Limit Comments Length'),
              //intelsat-2015  
              '#prefix'=>'<div style="float:left;clear:both;width:100%;'.$display.'"><div style="float:left;width:3%;margin-top:-5px;">',
              '#suffix'=>'</div>',  
            );
            if((isset($row->apply_limite_resumen_comentario) && !empty($row->apply_limite_resumen_comentario)) || !isset($row->id)){
                $result['limites_fs']['apply_limite_resumen_comentario']['#attributes']=array('checked'=>'checked');
            }
    
    $limite_resumen_comentario=red_despacho_boletin_report_get_limite_resumen_comentario($row);        
    $result['limites_fs']['limite_resumen_comentario']=array(
              '#type'=>'textfield',
              '#title'=>t('Limit comments length to'),
              //'#default_value'=>get_alerta_my_limite($row->limite_resumen_comentario,boletin_grupo_define_max_limite_resumen_comentario()),
              '#default_value'=>$limite_resumen_comentario,
              //'#required' => TRUE,
              //intelsat-2015  
              '#prefix'=>'<div style="float:left;padding-left:10px;'.$display.'">',
              '#suffix'=>'</div>',
              '#attributes'=>$text_attributes,
            );
    //intelsat-2015
    $result['limites_fs']['limite_resumen_comentario_label_caracteres']=array(
        '#value'=>$caracteres_html,
    );
    if(red_despacho_is_activado() && !empty($display)){
        $result['limites_fs']['limite_resumen_comentario_label_caracteres']['#prefix']='<div style="'.$display.'">';
        $result['limites_fs']['limite_resumen_comentario_label_caracteres']['#suffix']='</div>';
    }
    //
    return $result['limites_fs'];
}
function boletin_report_get_tipo_link_options(){
    $result=array();
    $result[1]=t('Links to Platform');
    $result[2]=t('Links to Web');    
    return $result;
}
function boletin_report_form_submit(&$form, &$form_state){
    global $user;
    //save_boletin_grupo_my_edit($form, $form_state);
    if(isset($form_state['clicked_button']) && !empty($form_state['clicked_button']) && $form_state['clicked_button']['#name']=='boleting_report_btn_submit'){
        $values=$form_state['values'];
        $created=time();
        //
        $is_todos_usuarios=$values['is_todos_usuarios'];
        //
        $c=array();
        $la=array();
        $contenido_fields=boletin_report_create_contenido_fields();
        foreach($contenido_fields as $i=>$f){
            $name=$f['name'];
            $c[$f['name']]=$values[$name];
            $limite_name=str_replace('is_','limite_',$f['name']);
            $la[$limite_name]=get_alerta_my_limite($values[$limite_name]);
            //intelsat-2015
            $orden_name=$f['name'].'_orden';
            $c[$orden_name]=boletin_report_inc_set_orden_values($values,$orden_name);
            //        
        }
        //intelsat-2015
        //$c['is_todos_noticias_usuario']=$c['is_todos_items'];
        //$c['is_todos_noticias_usuario_orden']=$c['is_todos_items_orden'];
        boletin_report_inc_set_noticias_usuario_fields_presave_by_items($c);
        //
        //$la['limite_noticias_destacadas']=get_alerta_my_limite($values['limite_noticias_destacadas'],3);
        $la['apply_limite_resumen']=0;
        if(isset($values['apply_limite_resumen']) && !empty($values['apply_limite_resumen'])){
            $la['apply_limite_resumen']=1;
        }
        //$la['limite_resumen']=get_alerta_my_limite($values['limite_resumen'],boletin_report_define_max_limite_resumen());
        $la['limite_resumen']=$values['limite_resumen'];        
        $activado=$values['activado'];
        //
        $la['apply_limite_resumen_comentario']=0;
        if(isset($values['apply_limite_resumen_comentario']) && !empty($values['apply_limite_resumen_comentario'])){
            $la['apply_limite_resumen_comentario']=1;         
        }
        //$la['limite_resumen_comentario']=get_alerta_my_limite($values['limite_resumen_comentario'],boletin_report_define_max_limite_resumen_comentario());
        $la['limite_resumen_comentario']=$values['limite_resumen_comentario'];        
        //$introduccion='';
        //$despedida='';
        $email_externos=$values['email_externos'];
        $is_editable=$values['is_editable'];
        $c['is_boletin_publico']=0;
        if(hontza_canal_rss_is_publico_activado()){
            if(isset($values['is_boletin_publico']) && !empty($values['is_boletin_publico'])){
                $c['is_boletin_publico']=1;
            }
        }
        //
        $id=0;
        $is_new=0;
        if(isset($values['my_id']) && !empty($values['my_id']) && is_numeric($values['my_id'])){
            $is_new=1;
            $id=$values['my_id'];
            $changed=$created;
            if(hontza_canal_rss_is_publico_activado()){
                $sql=sprintf('UPDATE {boletin_report_array} SET titulo="%s",send_method="%s",changed=%d,is_todos_usuarios=%d,is_todos_items=%d,is_todos_noticias_usuario=%d,is_todos_reports=%d,limite_todos_items=%d,limite_todos_noticias_usuario=%d,limite_todos_reports=%d,activado=%d,limite_resumen=%d,apply_limite_resumen=%d,limite_resumen_comentario=%d,apply_limite_resumen_comentario=%d,tipo_link=%d,email_externos="%s",is_editable=%d,is_todos_debates=%d,is_todos_wikis=%d,is_todos_items_orden=%d,is_todos_noticias_usuario_orden=%d,is_todos_reports_orden=%d,is_todos_debates_orden=%d,is_todos_wikis_orden=%d,is_boletin_publico=%d,limite_todos_debates=%d,limite_todos_wikis=%d WHERE id=%d',$values['titulo'],$values['send_method'],$changed,$is_todos_usuarios,$c['is_todos_items'],$c['is_todos_noticias_usuario'],$c['is_todos_reports'],$la['limite_todos_items'],$la['limite_todos_noticias_usuario'],$la['limite_todos_reports'],$activado,$la['limite_resumen'],$la['apply_limite_resumen'],$la['limite_resumen_comentario'],$la['apply_limite_resumen_comentario'],$values['tipo_link'],$email_externos,$is_editable,$c['is_todos_debates'],$c['is_todos_wikis'],$c['is_todos_items_orden'],$c['is_todos_noticias_usuario_orden'],$c['is_todos_reports_orden'],$c['is_todos_debates_orden'],$c['is_todos_wikis_orden'],$c['is_boletin_publico'],$la['limite_todos_debates'],$la['limite_todos_wikis'],$values['my_id']);
            }else{            
                $sql=sprintf('UPDATE {boletin_report_array} SET titulo="%s",send_method="%s",changed=%d,is_todos_usuarios=%d,is_todos_items=%d,is_todos_noticias_usuario=%d,is_todos_reports=%d,limite_todos_items=%d,limite_todos_noticias_usuario=%d,limite_todos_reports=%d,activado=%d,limite_resumen=%d,apply_limite_resumen=%d,limite_resumen_comentario=%d,apply_limite_resumen_comentario=%d,tipo_link=%d,email_externos="%s",is_editable=%d,is_todos_debates=%d,is_todos_wikis=%d,is_todos_items_orden=%d,is_todos_noticias_usuario_orden=%d,is_todos_reports_orden=%d,is_todos_debates_orden=%d,is_todos_wikis_orden=%d,limite_todos_debates=%d,limite_todos_wikis=%d WHERE id=%d',$values['titulo'],$values['send_method'],$changed,$is_todos_usuarios,$c['is_todos_items'],$c['is_todos_noticias_usuario'],$c['is_todos_reports'],$la['limite_todos_items'],$la['limite_todos_noticias_usuario'],$la['limite_todos_reports'],$activado,$la['limite_resumen'],$la['apply_limite_resumen'],$la['limite_resumen_comentario'],$la['apply_limite_resumen_comentario'],$values['tipo_link'],$email_externos,$is_editable,$c['is_todos_debates'],$c['is_todos_wikis'],$c['is_todos_items_orden'],$c['is_todos_noticias_usuario_orden'],$c['is_todos_reports_orden'],$c['is_todos_debates_orden'],$c['is_todos_wikis_orden'],$la['limite_todos_debates'],$la['limite_todos_wikis'],$values['my_id']);
            }
            db_query($sql);
        }else{
            if(hontza_canal_rss_is_publico_activado()){
                $sql=sprintf('INSERT INTO {boletin_report_array}(titulo,send_method,created,uid,grupo_nid,is_todos_usuarios,is_todos_items,is_todos_noticias_usuario,is_todos_reports,limite_todos_items,limite_todos_noticias_usuario,limite_todos_reports,activado,limite_resumen,apply_limite_resumen,limite_resumen_comentario,apply_limite_resumen_comentario,tipo_link,email_externos,is_editable,is_todos_debates,is_todos_wikis,is_todos_items_orden,is_todos_noticias_usuario_orden,is_todos_reports_orden,is_todos_debates_orden,is_todos_wikis_orden,is_boletin_publico,limite_todos_debates,limite_todos_wikis) VALUES("%s","%s","%s","%s",%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,"%s",%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d)',$values['titulo'],$values['send_method'],$created,$user->uid,$values['grupo_nid'],$is_todos_usuarios,$c['is_todos_items'],$c['is_todos_noticias_usuario'],$c['is_todos_reports'],$la['limite_todos_items'],$la['limite_todos_noticias_usuario'],$la['limite_todos_reports'],$activado,$la['limite_resumen'],$la['apply_limite_resumen'],$la['limite_resumen_comentario'],$la['apply_limite_resumen_comentario'],$values['tipo_link'],$email_externos,$is_editable,$c['is_todos_debates'],$c['is_todos_wikis'],$c['is_todos_items_orden'],$c['is_todos_noticias_usuario_orden'],$c['is_todos_reports_orden'],$c['is_todos_debates_orden'],$c['is_todos_wikis_orden'],$c['is_boletin_publico'],$la['limite_todos_debates'],$la['limite_todos_wikis']);
            }else{
                $sql=sprintf('INSERT INTO {boletin_report_array}(titulo,send_method,created,uid,grupo_nid,is_todos_usuarios,is_todos_items,is_todos_noticias_usuario,is_todos_reports,limite_todos_items,limite_todos_noticias_usuario,limite_todos_reports,activado,limite_resumen,apply_limite_resumen,limite_resumen_comentario,apply_limite_resumen_comentario,tipo_link,email_externos,is_editable,is_todos_debates,is_todos_wikis,is_todos_items_orden,is_todos_noticias_usuario_orden,is_todos_reports_orden,is_todos_debates_orden,is_todos_wikis_orden,limite_todos_debates,limite_todos_wikis) VALUES("%s","%s","%s","%s",%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,%d,"%s",%d,%d,%d,%d,%d,%d,%d,%d,%d,%d)',$values['titulo'],$values['send_method'],$created,$user->uid,$values['grupo_nid'],$is_todos_usuarios,$c['is_todos_items'],$c['is_todos_noticias_usuario'],$c['is_todos_reports'],$la['limite_todos_items'],$la['limite_todos_noticias_usuario'],$la['limite_todos_reports'],$activado,$la['limite_resumen'],$la['apply_limite_resumen'],$la['limite_resumen_comentario'],$la['apply_limite_resumen_comentario'],$values['tipo_link'],$email_externos,$is_editable,$c['is_todos_debates'],$c['is_todos_wikis'],$c['is_todos_items_orden'],$c['is_todos_noticias_usuario_orden'],$c['is_todos_reports_orden'],$c['is_todos_debates_orden'],$c['is_todos_wikis_orden'],$la['limite_todos_debates'],$la['limite_todos_wikis']);
            }
            db_query($sql);
            $id=db_last_insert_id('boletin_report_array','id');
        }
        //intelsat-2016
        //boletin_report_mcapi_save_mailchimp_list_id($id,$values);
        boletin_report_mcapi_save_mailchimp_fields($id,$values);
        
        $row=boletin_report_get_row($id);
        boletin_report_save_usuarios($row->id,$values['usuarios']);
        $categorias=boletin_report_get_categorias_by_values($values);
        boletin_report_save_categorias($row->id,$categorias);
        //intelsat-2015
        if(red_despacho_is_activado()){
            red_despacho_boletin_report_save_tipos_fuente($row->id,$values);
        }
        if(!$is_new){
            drupal_goto('boletin_report/list');
        }    
    }
}
function boletin_report_define_max_limite_resumen(){
   return boletin_grupo_define_max_limite_resumen();
}
function boletin_report_define_max_limite_resumen_comentario(){
   return boletin_grupo_define_max_limite_resumen_comentario(); 
}
function boletin_report_table($is_sql=0,$is_boletin_publico=0){
   global $user;
   //intelsat-2015
   global $base_url;
    
    $output='';
    //
    $where=array();
    $where[]='1';
    if(!hontza_is_user_anonimo()){
        $where[]='ou.uid='.$user->uid;
    }
    $where[]='n.type="grupo"';
    $where[]='NOT br.id IS NULL';
    if(hontza_canal_rss_is_publico_activado()){
        if($is_boletin_publico){
            $where[]='br.is_boletin_publico=1';
        }
    }    
    $my_grupo=og_get_group_context();
    if(isset($my_grupo->nid) && !empty($my_grupo->nid)){ 
        $where[]='n.nid='.$my_grupo->nid;
    }
    //
    /*if($user->uid!=$uid){
        return t('You can not edit the Personalized alert from other user');
    }*/
    //$result=drupal_get_form('aleboletin_report_rta_user_form');

    //
    $my_limit=variable_get('default_nodes_main', 10);
    //
    $sort='asc';
    $field='titulo';
    if(isset($_REQUEST['sort']) && !empty($_REQUEST['sort'])){
        $sort=$_REQUEST['sort'];
    }
    //$is_numeric=0;
    $is_date_of_last_bulletin=0;
    if(isset($_REQUEST['order']) && !empty($_REQUEST['order'])){
        $order=$_REQUEST['order'];
        if($order==t('Group')){
            $field='title';
        }else if($order==t('Method')){
            $field='send_method';
        }else if($order==t('Creation date')){
            $field='row_created';
        }else if($order==t('Date')){
            $is_date_of_last_bulletin=1;
            //$field='fecha';
        }        
    }
    //
    $sql='SELECT br.id as boletin_report_array_id,n.title,n.nid,br.*,br.created AS row_created
    FROM {node} n
    LEFT JOIN {og_uid} ou ON n.nid=ou.nid
    LEFT JOIN {boletin_report_array} br ON n.nid=br.grupo_nid 
    WHERE '.implode(' AND ',$where).'
    GROUP BY br.id     
    ORDER BY '.$field.' '.$sort;
    if($is_sql){
        return $sql;
    }
    $res = db_query($sql);
    
    /*
    $headers=array();
    $headers[0]=t('Title');
    $headers[1]=t('Group');
    $headers[2]=t('Method');
    $headers[3]=t('Created');
    $headers[4]=t('Actions');
    */
    
     //intelsat-2015
    $is_alerta_publico=hontza_canal_rss_is_alerta_publico(); 
    
    $headers=boletin_report_define_table_headers(1,$is_alerta_publico);
    
    $rows=array();
    //$output.=my_create_boton_boletin_volver();
    //$output.=my_create_boton_boletin_cron();
    $kont=0;
    while ($r = db_fetch_object($res)) {
      $rows[$kont]=array();
      $icono_activado=get_icono_activado_by_row($r);
      $rows[$kont][0]=$icono_activado.'&nbsp;'.$r->titulo;
      $rows[$kont][1]=$r->title;
      $rows[$kont][2]=get_metodo_name($r->send_method);
      $rows[$kont][3]='';
      if(!empty($r->created)){
        $rows[$kont][3]=date('Y-m-d',$r->created);
      }
      $date_of_last_bulletin=boletin_report_get_date_of_last_bulletin($r);
      $rows[$kont][4]='';
      //gemini-2014
      $str_date_of_last_bulletin='';
      //
      if(!empty($date_of_last_bulletin)){
        $rows[$kont][4]=hontza_unset_seconds_by_date($date_of_last_bulletin);
        //gemini-2014
        $str_date_of_last_bulletin=strtotime($date_of_last_bulletin);
        //
        $rows[$kont]['date_of_last_bulletin']=$str_date_of_last_bulletin;
      }
      //intelsat-2015
      $is_edit=boletin_report_is_editable_by_row($r);
      $rows[$kont][5]=boletin_report_set_edition_type_value_string($is_edit);
      $archive_url=boletin_report_inc_get_archive_url($r,$is_alerta_publico);
      $archive=l(my_get_icono_action('boletin_historico', t('Archive')),$archive_url,array('absolute'=>TRUE,'html'=>true,'query'=>drupal_get_destination(),'attributes'=>array('title'=>t('Archive'),'alt'=>t('Archive'))));                
      $rows[$kont][6]=$archive;
      //intelsat-2015      
      //$rows[$kont][7]=boletin_report_get_acciones($r,$purl);
      $rows[$kont][7]=boletin_report_get_acciones($r,$purl,$is_alerta_publico);
      if($is_alerta_publico){
          unset($rows[$kont][6]);
          $rows[$kont][6]=$rows[$kont][7];
          unset($rows[$kont][7]);
          if(hontza_is_user_anonimo()){  
            unset($rows[$kont][5]);
          }          
      }else{
          //intelsat-2015
          if(red_despacho_is_activado()){
              unset($rows[$kont][5]);
          }
      }      
      //gemini-2014
      if(isset($rows[$kont]['date_of_last_bulletin'])){
          unset($rows[$kont]['date_of_last_bulletin']);
      }
      unset($rows[$kont][2]);
      unset($rows[$kont][3]);
      //intelsat-2015
      if(isset($my_grupo->nid) && !empty($my_grupo->nid)){ 
          unset($rows[$kont][1]);
      }
      //
      $rows[$kont]=array_values($rows[$kont]);
      if(!empty($str_date_of_last_bulletin)){
          $rows[$kont]['date_of_last_bulletin']=$str_date_of_last_bulletin;
      }
      //intelsat-2015
      if($is_alerta_publico){
          $num=boletin_report_inc_get_rows_array_num($rows[$kont]);
          $my_row=$rows[$kont][$num-1];
          $rows[$kont][$num-1]=$archive;
          $rows[$kont][]=$my_row;
      }    
      //
      $kont++;
    }

    if($is_date_of_last_bulletin){
        $rows=array_ordenatu($rows,'date_of_last_bulletin',strtolower($sort),1);
    }
    $rows=hontza_unset_array($rows,array('date_of_last_bulletin'));        
    $rows=my_set_estrategia_pager($rows, $my_limit);

  if (count($rows)>0) {
    /*$feed_url = url('idea_rss.xml', array('absolute' => TRUE));
    drupal_add_feed($feed_url, variable_get('site_name', 'Drupal') . ' ' . t('RSS'));*/
    $output .= theme('table',$headers,$rows);
    $output .= theme('pager', NULL, $my_limit);
  }
  else {

    $output.= '<div id="first-time">' .t('There are no customided bulletins for this user'). '</div>';
  }
  //drupal_set_title(t('Listado de ideas'));

  return $output;
}
function boletin_report_get_list($id=''){
    $result=array();
    //
    //intelsat-2016
    if(empty($id) || is_numeric($id)){    
        $grupo_nid='';
        $where=array();
        $where[]='1';
        if(!empty($id)){
            $where[]='br.id='.$id;
        }else{
            $my_grupo=og_get_group_context();
            if(isset($my_grupo->nid) && !empty($my_grupo->nid)){
                $grupo_nid=$my_grupo->nid;
            }
            if(!empty($grupo_nid)){
                $where[]='br.grupo_nid='.$grupo_nid;
            }
        }    
        $sql='SELECT br.*,br.id as boletin_report_array_id 
        FROM {boletin_report_array} br
        WHERE '.implode(' AND ',$where).'
        ORDER BY br.created ASC';
        //
        $res=db_query($sql);
        $kont=0;
        while($row=db_fetch_object($res)){
            $result[$kont]=$row;
            $result[$kont]->usuarios=boletin_report_get_usuarios_id_array($row->id,$row->grupo_nid,0);
            $result[$kont]->categorias=boletin_report_get_categorias_tid_array($row->id);
            $result[$kont]->email_externos_value=$row->email_externos;
            //intelsat-2015
            if(red_despacho_is_activado()){
                $result[$kont]->tipos_fuente=red_despacho_boletin_report_get_tipos_fuente_tid_array($row->id);
            }
            boletin_report_inc_set_noticias_usuario_fields_by_items($result[$kont]);
            //
            $kont++;
        }
    }    
    return $result;
}
function boletin_report_get_usuarios_id_array($id,$grupo_nid,$is_default=0){
    $result=array();
    $my_list=boletin_report_get_usuarios_list($id);
    if(count($my_list)>0){
        foreach($my_list as $i=>$row){
            $result[]=$row->uid;
        }
    }else{
        if($is_default){
            $options=get_usuarios_grupo_options($grupo_nid);
            $result=array_keys($options);
            //echo print_r($result,1);
        }
    }
    return $result;
}
function boletin_report_get_usuarios_list($id){
    $result=array();
    $where=array();
    $where[]='1';
    $where[]='boletin_report_array_id='.$id;
    $sql='SELECT * FROM boletin_report_array_usuarios WHERE '.implode(' AND ',$where);    
    $res=db_query($sql);
    while($row=db_fetch_object($res)){
        $result[]=$row;
    }
    $result=hontza_unset_usuarios_caducados($result);    
    return $result;
}
function boletin_report_get_acciones($r,$purl_in='',$is_alerta_publico=0){
    global $base_url;
    $html=array();
    $atzizkia='';
    /*if(in_array($r->tipo,array('categoria','usuario'))){
        $atzizkia='_'.$r->tipo;
    }*/
    //if(boletin_report_is_permiso_gestion($r->nid,1,'',1)){
    //if(boletin_report_is_permiso_editar($r->grupo_nid)){
    //intelsat-2015
    $purl=$purl_in;
    if(empty($purl_in)){
        $purl=boletin_report_get_grupo_purl($r->grupo_nid);
    }
    //gemini-2014
    //AVISO::::se ha comentado
    /*if(boletin_report_edit_user_access($r->grupo_nid)){
        //$html[]=l(my_get_icono_action('edit', t('Edit')),'boletin_report/'.$r->id.'/edit'.$atzizkia,array('html'=>true,'query'=>drupal_get_destination(),array('attributes'=>array('title'=>t('Edit'),'alt'=>t('Edit')))));
        $html[]=l(my_get_icono_action('edit', t('Edit')),$base_url.'/'.$purl.'/boletin_report/'.$r->id.'/edit'.$atzizkia,array('absolute'=>true,'html'=>true,'query'=>drupal_get_destination(),'attributes'=>array('title'=>t('Edit'),'alt'=>t('Edit'))));    
    }*/
    //intelsat-2015
    if(!$is_alerta_publico){ 
        if(boletin_report_is_permiso_editar($r->grupo_nid)){    
            //gemini-2014
            $html[]=l(my_get_icono_action('settings', t('Edit settings')),$base_url.'/'.$purl.'/boletin_report/'.$r->id.'/edit'.$atzizkia,array('absolute'=>true,'html'=>true,'query'=>drupal_get_destination(),'attributes'=>array('title'=>t('Edit settings'),'alt'=>t('Edit settings'))));    

            //$html[]=l(my_get_icono_action('delete', t('Delete')),'boletin_report/'.$r->id.'/delete'.$atzizkia,array('html'=>true,'query'=>drupal_get_destination(),array('attributes'=>array('title'=>t('Delete'),'alt'=>t('Delete')))));
            $html[]=l(my_get_icono_action('delete', t('Delete')),$base_url.'/'.$purl.'/boletin_report/'.$r->id.'/delete'.$atzizkia,array('absolute'=>true,'html'=>true,'query'=>drupal_get_destination(),'attributes'=>array('title'=>t('Delete'),'alt'=>t('Delete'))));
            //$html[]=l(my_get_icono_action('email', t('Send Bulletin')),'boletin_report/'.$r->id.'/launch'.$atzizkia,array('html'=>true,'query'=>drupal_get_destination(),array('attributes'=>array('title'=>t('Send Bulletin'),'alt'=>t('Send Bulletin'))))); 
            $html[]=l(my_get_icono_action('email', t('Send Bulletin')),$base_url.'/'.$purl.'/boletin_report/'.$r->id.'/launch'.$atzizkia,array('absolute'=>true,'html'=>true,'query'=>drupal_get_destination(),'attributes'=>array('title'=>t('Send Bulletin'),'alt'=>t('Send Bulletin'))));     
        }
    }    
    if(boletin_report_is_editable_by_row($r) && !hontza_solr_search_is_usuario_lector()){
            $url=boletin_report_define_url_edit_text($r,$purl);
            $title_edit_contents=t('Edit contents');
            //intelsat-2015
            if(!red_despacho_is_activado()){
                $html[]=l(my_get_icono_action('edit',$title_edit_contents),$url,array('absolute'=>TRUE,'html'=>true,'query'=>drupal_get_destination(),'attributes'=>array('title'=>$title_edit_contents,'alt'=>$title_edit_contents)));
            }
            $html[]=boletin_report_inc_get_previsualizacion_link($r,$purl);
            $url_reload=boletin_report_define_url_reload($r,$purl);
            //intelsat-2015
            if(!red_despacho_is_activado()){
                if(!empty($url_reload)){
                    $html[]=l(my_get_icono_action('reload_boletin', t('Reload')),$url_reload,array('absolute'=>TRUE,'html'=>true,'query'=>drupal_get_destination(),'attributes'=>array('title'=>t('Reload'),'alt'=>t('Reload'))));            
                }
            }    
    }else{
        //intelsat-2015
        if(!$is_alerta_publico){    
            $html[]=l(my_get_icono_action('edit', t('Edit title')),$base_url.'/'.$purl.'/boletin_report/'.$r->id.'/my_web',array('absolute'=>TRUE,'html'=>true,'query'=>drupal_get_destination(),'attributes'=>array('title'=>t('View Next Customised Bulletin'),'alt'=>t('View Next Customised Bulletin'))));
        }else{
            if(hontza_canal_rss_is_publico_activado()){
                $html[]=publico_alerta_get_subscribir_link($r);
            }
        }
        //$html[]=boletin_report_inc_get_previsualizacion_link($r,$purl);
        //intelsat-2015
        if(!($is_alerta_publico && hontza_is_user_anonimo())){
            $html[]=boletin_report_inc_get_previsualizacion_link($r,$purl,$is_alerta_publico);
        }
    }
    //$html[]=l(my_get_icono_action('boletin_historico', t('Sent Bulletins')),$base_url.'/'.$purl.'/boletin_report/'.$r->id.'/historico',array('absolute'=>TRUE,'html'=>true,'query'=>drupal_get_destination(),'attributes'=>array('title'=>t('Sent Bulletins'),'alt'=>t('Sent Bulletins'))));                
    /*if(boletin_report_is_permiso_gestion($r->nid)){
        if(isset($r->id) && !empty($r->id)){
            $my_nid=get_grupo_boletin_introduccion_nid($r->nid);
            //print $my_nid;
            if(empty($my_nid)){
                $html[]=l(my_get_icono_action('introduccion', t('Header')),'node/add/boletin-grupo-introduccion/'.$r->nid,array('html'=>true,'query'=>drupal_get_destination()));
            }else{
                $html[]=l(my_get_icono_action('introduccion', t('Header')),'node/'.$my_nid.'/edit',array('html'=>true,'query'=>drupal_get_destination()));
            
            }
            //
            $my_nid=get_grupo_boletin_despedida_nid($r->nid);
            //print $my_nid;
            if(empty($my_nid)){
                $html[]=l(my_get_icono_action('despedida', t('Footer')),'node/add/boletin-grupo-despedida/'.$r->nid,array('html'=>true,'query'=>drupal_get_destination()));
            }else{
                $html[]=l(my_get_icono_action('despedida', t('Footer')),'node/'.$my_nid.'/edit',array('html'=>true,'query'=>drupal_get_destination()));

            }
        }

    }*/
    //$html[]=l(my_get_icono_action('no_recibir', t('Not to receive')),'boletin_grupo/'.$r->nid.'/my_no_recibir',array('html'=>true,'query'=>drupal_get_destination()));

    //$html[]=l(my_get_icono_action('delete', t('Delete')),'alerta_user/'.$r->id.'/my_delete'.$atzizkia,array('html'=>true,'query'=>drupal_get_destination()));
    return add_div_actions(implode('&nbsp;',$html),1,'','boletin_report');
}
function boletin_report_no_group_selected_denied(){
    $my_grupo=og_get_group_context();
    if(isset($my_grupo->nid) && !empty($my_grupo->nid)){
        //        
    }else{
        drupal_access_denied();
        exit();
    }    
}
function boletin_report_save_usuarios($id,$subgrupo){
	global $user;
        boletin_report_delete_usuarios($id);
	if(count($subgrupo)>0){
            foreach($subgrupo as $i=>$uid){
                boletin_report_insert_usuarios($id,$uid);
            }            
	}        
}
function boletin_report_delete_usuarios($id){
	$sql='DELETE FROM {boletin_report_array_usuarios} WHERE boletin_report_array_id='.$id;
	db_query($sql);
}
function boletin_report_insert_usuarios($id,$uid){
	$sql='INSERT boletin_report_array_usuarios(boletin_report_array_id,uid) VALUES('.$id.','.$uid.')';
	db_query($sql);
}
function boletin_report_delete_form(){
   boletin_report_no_group_selected_denied(); 
   $id=arg(1);
   $row=boletin_report_get_row($id);
   $grupo_nid='';
   if(isset($row->grupo_nid) && !empty($row->grupo_nid)){
    $grupo_nid=$row->grupo_nid;
    /*if(!boletin_report_is_permiso_editar($grupo_nid)){
        drupal_access_denied();
        exit();
    }*/
   }
   boletin_report_my_access($grupo_nid);
       
        $form['my_id']=array(
            '#type'=>'hidden',
            '#default_value' =>arg(1),
        );
    //
    $form['borrar_msg']=array(
        '#value'=>t('This action cannot be undone.').'<BR>',
    );

    $form['boletin_report_delete_btn_submit']=array(
  '#type' => 'submit',
  '#value' => t('Delete'),
);
    
  
$my_destination='boletin_report/list';
    

$form['boletin_report_delete_volver']=array(
  '#value' => l(t('Cancel'),$my_destination),  

);

    return $form;
}
function boletin_report_delete_form_submit(&$form, &$form_state){
    $values=$form_state['values'];    
    if(isset($values['my_id']) && !empty($values['my_id']) && is_numeric($values['my_id'])){
        $id=$values['my_id'];
        boletin_report_delete_usuarios($id);
        //boletin_report_delete_no_recir($values['grupo_nid'],'',0);
        //boletin_report_delete_today($id);
        //
        $sql='DELETE FROM {boletin_report_array} WHERE id='.$id;
        db_query($sql);
        $sql_historico='DELETE FROM {boletin_report_array_edit} WHERE boletin_report_array_id='.$id;
        db_query($sql_historico);
    }    
}
function boletin_report_web_callback(){
    boletin_report_no_group_selected_denied(); 
    //boletin_report_my_access();
    $content='';
    /*$id=arg(1);
    $boletin_report_array_edit_id=arg(3);
    $bulletin_text_nid=0;
    $text_row='';
    $is_edit_content=0;
    if(!empty($boletin_report_array_edit_id)){
        //$text_row=boletin_report_get_edit_text_row('',$boletin_report_array_edit_id);
        $text_row=boletin_report_get_edit_text_row_by_id($boletin_report_array_edit_id);
        $bulletin_text_nid=$text_row->nid;
        $is_edit_content=1;        
    }
    $content=boletin_report_get_content($id,$bulletin_text_nid,$text_row,$is_edit_content);
    if($is_edit_content){
        print alerta_add_css($content);
        exit();
    }*/
    /*$is_pdf=0;
    $param=arg(2);
    if(!empty($param) && $param=='pdf'){
        $is_pdf=1;
    }*/
     //intelsat-2015
    $is_alerta_publico=hontza_canal_rss_is_alerta_publico(); 
    $is_pdf=boletin_report_pdf_is_pdf();
    $is_print_exit=1;
    $volver='';
    if($is_pdf){
        $is_print_exit=0;
    }else{
        $volver=l(t('Return'),$_REQUEST['destination'],array('attributes'=>array('class'=>'back_left')));
    }    
    $content=boletin_report_get_content_html(0,$is_print_exit);
    $boletin_report_title_of_bulletin_automatico_form='';
    $is_pdf=boletin_report_pdf_is_pdf();
    //intelsat-2015
    //if(!$is_pdf){
    if(!$is_pdf && !$is_alerta_publico){        
        $boletin_report_title_of_bulletin_automatico_form=drupal_get_form('boletin_report_inc_title_of_bulletin_automatico_form',$content);
        $content=red_despacho_boletin_report_get_boletin_report_forward_content_view_web($content);
    }
    //
    $content=$volver.$boletin_report_title_of_bulletin_automatico_form.$content;
    return $content;
}
function boletin_report_exec($br_in,$nombre_dia,$por_correo=1,$bulletin_text_nid=0,$text_row='',$is_edit_content=0){
    global $user,$base_url;
    $content='';
    $my_message='';
    $br=$br_in;
    $is_boletin_report=1;
    $br->is_boletin_report=$is_boletin_report;
    $br->categorias=boletin_report_set_categorias($br);
    $bulletin_text_content='';
    //intelsat-2016
    $mail_array=array();
                $grupo=node_load($br->grupo_nid);
                /*$grupo_title='';
                if(isset($grupo->nid) && !empty($grupo->nid)){
                    $grupo_title=': '.$grupo->title;
                }*/
                //$br_title=': '.$br->titulo;
                //$subject=t('Customised Bulletin').$br_title;
                //intelsat-2015
                $titulo_boletin=boletin_report_inc_get_title_of_bulletin_automatico('',$is_edit_content,$br);
                /*if(isset($br->titulo) && !empty($br->titulo)){
                    $subject=$br->titulo;*/
                if(!empty($titulo_boletin)){
                    $subject=$titulo_boletin;
                }else{
                //    
                    $subject=t('Customised Bulletin');
                }
                //
                $html_body=array();
                $usuarios=boletin_report_get_usuarios_rows($br);                
                //
                if(!empty($bulletin_text_nid) || $is_edit_content){
                    $bulletin_text_content=boletin_report_get_text_content($bulletin_text_nid);
                    $bulletin_text_content=boletin_report_set_img_src_absolutos($bulletin_text_content);
                    if(empty($por_correo) && $is_edit_content){
                        return $bulletin_text_content;
                    }                    
                    //AVISO::::solo para conseguir
                    $sended_array=boletin_report_get_sended_array($br);
                    $html_body[]=$bulletin_text_content;
                }else{
                    $html_body[]=boletin_report_por_categorias($br,$hay_todos_items,$hay_todos_noticias_usuario,$hay_todos_reports,$my_message,$sended_array,$hay_todos_debates,$hay_todos_wikis);
                }
                //
                if(count($html_body)>0){
                    $content=implode('',$html_body);

                    //$content=add_introduccion_despedida_html($content,$grupo,'',$subject);


                    //print implode('',$html_body);exit();
                    //
                    //my_send_mail('inazio@netkam.com',t('Group Bulletin').$grupo_title, implode('',$html_body));
                    
                    //gemini-2014
                    /***********************************Esto se ha pasado de abajo a este lugar*********************/
                    $is_no_hay=0;
                    //$historico_nid=boletin_report_save_historico($br,$my_message,$is_no_hay,$user,$content,$grupo,$subject,$is_boletin_report,$por_correo,$sended_array,$bulletin_text_nid,$text_row);
                    //print $historico_nid;exit();
                    $content_historico=$content;
                     if(is_user_invitado()){
                        $respuesta_content_historico=get_invitado_respuesta_content($br,$my_message,$is_no_hay,$user);
                        $content_historico=$respuesta_content_historico;
                     }

                     if(!empty($content_historico)){
                        if(red_despacho_boletin_report_is_add_introduccion_despedida_html($bulletin_text_nid,$is_edit_content)){    
                            $content_historico=add_introduccion_despedida_html($content_historico,$grupo,$user->uid,$subject,'',$is_boletin_report);
                        }    
                     }


                     if(empty($content_historico) && !$por_correo){
                        $content_historico=get_content_by_my_message($content_historico, $por_correo, $my_message,1);
                     }
                     //intelsat-2015
                     if(empty($bulletin_text_nid)){
                        $content_historico=red_despacho_boletin_report_get_current_content($content_historico,$subject,$bulletin_text_nid);
                        //intelsat-2016
                        $content_historico=boletin_report_inc_get_boletin_report_automatico_content($br,$content_historico);                                                                                          
                     }
                     $historico_nid=boletin_report_save_aviso_procesado($br, $por_correo, $my_message,$sended_array,$bulletin_text_nid,$text_row,$content_historico);
                     /************************************************************************************************/
                    //                    
                    if(count($usuarios)>0){                        
                        $my_kont=0;
                        foreach($usuarios as $z=>$u){
                            $is_activo=is_activo_boletin_grupo_user($br->grupo_nid, $u->uid,$is_boletin_report);

                            if(!$is_activo){
                                continue;
                            }

                            $user_mail=$u->mail;
                            //$user_mail='inazio@netkam.com';
                            /*if(user_access('root')){
                                $user_mail='inazio@netkam.com';                                
                            }*/
                            //
                            //if($my_kont<1){
                                if($por_correo){
                                    if(is_user_invitado($u)){
                                        $respuesta_content=get_invitado_respuesta_content($br,$my_message,$is_no_hay,$u);
                                        $current_content=$respuesta_content;
                                        if(!boletin_report_is_content_editado($bulletin_text_nid,$is_edit_content)){
                                           $current_content=add_introduccion_despedida_html($respuesta_content,$grupo,$u->uid,$subject,'',$is_boletin_report);
                                        }    
                                    }else{
                                        $current_content=$content;
                                        if(!boletin_report_is_content_editado($bulletin_text_nid,$is_edit_content)){
                                            $current_content=add_introduccion_despedida_html($content,$grupo,$u->uid,$subject,'',$is_boletin_report);
                                        }    
                                    }
                                    //intelsat-2015
                                    $current_content=red_despacho_boletin_report_get_current_content($current_content,$subject,$bulletin_text_nid);
                                    //intelsat-2016
                                    $current_content=boletin_report_inc_get_boletin_report_automatico_content($br,$current_content);
                                    
                                    if(boletin_report_hay_novedades($hay_todos_items,$hay_todos_noticias_usuario,$hay_todos_reports,$hay_todos_debates,$hay_todos_wikis,$bulletin_text_content,$bulletin_text_nid,$br)){
                                        //intelsat-2016
                                        //my_send_mail($user_mail,$subject, $current_content,$br->send_method,$is_activo,$historico_nid);
                                        boletin_report_mcapi_my_send_mail($user_mail,$subject, $current_content,$br->send_method,$is_activo,$historico_nid);
                                        $mail_array[]=$user_mail;
                                    }                                       
                                }
                            //}
                            $my_kont++;
                        }                        
                    }
                    //
                    if($por_correo){
                        if(boletin_report_exist_email_externos($br->email_externos)){                            
                            $email_externos_array=explode(',',$br->email_externos);
                            foreach($email_externos_array as $i=>$user_mail){
                                 $is_activo=1;                                  
                                 $current_content=$content;
                                 if(!boletin_report_is_content_editado($bulletin_text_nid,$is_edit_content)){                                    
                                    $current_content=add_introduccion_despedida_html($content,$grupo,0,$subject,'',$is_boletin_report);                                    
                                 }
                                 //intelsat-2015                                 
                                 $current_content=red_despacho_boletin_report_get_current_content($current_content,$subject,$bulletin_text_nid);
                                 //intelsat-2016
                                 $current_content=boletin_report_inc_get_boletin_report_automatico_content($br,$current_content);
                                 if(boletin_report_hay_novedades($hay_todos_items,$hay_todos_noticias_usuario,$hay_todos_reports,$hay_todos_debates,$hay_todos_wikis,$bulletin_text_content,$bulletin_text_nid,$br)){                                    
                                    //intelsat-2015 
                                    //my_send_mail($user_mail,$subject, $current_content,$br->send_method,$is_activo,$historico_nid);
                                    //intelsat-2016
                                    //my_send_mail($user_mail,$subject, $current_content,$br->send_method,$is_activo,$historico_nid,1,$br);
                                    boletin_report_mcapi_my_send_mail($user_mail,$subject, $current_content,$br->send_method,$is_activo,$historico_nid,1,$br);
                                    $mail_array[]=$user_mail;
                                 }
                                 $my_kont++;
                            }
                        }                        
                    }
                }
     //intelsat-2016
     boletin_report_mcapi_my_send_mail_array($mail_array,$subject, $current_content,$br->send_method,$is_activo,$historico_nid,0,$br,$por_correo);       
                
     if(is_user_invitado()){
        $respuesta_content=get_invitado_respuesta_content($br,$my_message,$is_no_hay,$user);
        $content=$respuesta_content;
     }

     if(!empty($content)){
        $content=add_introduccion_despedida_html($content,$grupo,$user->uid,$subject,'',$is_boletin_report);            
     }
    
     if(empty($content) && !$por_correo){
        $content=get_content_by_my_message($content, $por_correo, $my_message,1);
     }
     //intelsat-2015        
     if(red_despacho_is_activado()){
     //if(red_dashboard_is_despacho_no_dashboard()){    
        if(red_despacho_boletin_report_is_custom_content()){
             $content=red_despacho_boletin_report_get_current_content($content,$subject,$bulletin_text_nid);             
         }
         /*print $content;
         exit();*/                        
     }
     //intelsat-2016
     $content=boletin_report_inc_get_boletin_report_automatico_content($br,$content);
     boletin_report_inc_update_boletin_report_automatico_editados_sended($br,$por_correo);
     //boletin_report_save_aviso_procesado($br, $por_correo, $my_message,$sended_array,$bulletin_text_nid,$text_row,$content);
     return $content;
}
function boletin_report_get_usuarios_rows($br){
    return get_boletin_usuarios_rows($br,1);
}
function boletin_report_get_items($br,$node_type='item',$report_type='item_report'){
    $result=array();
    $where=array();
    if(isset($br->grupo_nid) && !empty($br->grupo_nid)){
        $where[]="(og_ancestry.group_nid = ".$br->grupo_nid.")"; 
    }else{
        return $result;
    }
    //    
    //$where[]="node.status <> 0";
    $where[]="node.type in ('".$node_type."')";
    $where[]="br.report_type='".$report_type."'";
    $where[]="br.sended <> 1";
    //$where[]="br.sended!=1";
    if(in_array($node_type,array('debate','wiki','my_report'))){
        $order_by="ORDER BY node_created DESC";
    }else{
        $order_by="ORDER BY votingapi_cache_node_average_value DESC,node_created DESC";
    }
    //
    $sql="SELECT br.*,
        node.created AS node_created,node.changed AS node_changed,
        node.uid AS node_uid,
        votingapi_cache_node_average.value AS votingapi_cache_node_average_value
		FROM {boletin_report_node} br 
                LEFT JOIN {node} node ON br.nid=node.nid 
		LEFT JOIN {og_ancestry} og_ancestry ON node.nid = og_ancestry.nid
                LEFT JOIN {votingapi_cache} votingapi_cache_node_average ON node.nid = votingapi_cache_node_average.content_id AND (votingapi_cache_node_average.content_type = 'node' AND votingapi_cache_node_average.function = 'average')
		WHERE ".implode(" AND ",$where)." 
		GROUP BY br.nid ".$order_by;
    //
    /*if(user_access('root')){
        drupal_set_message($sql);
    }*/
    $res=db_query($sql);
    $kont=0;
    while($row=db_fetch_object($res)){
        //intelsat-2015        
        $in_tipos_fuente=array();
        if(red_despacho_is_activado()){
            if(!red_despacho_boletin_report_in_tipos_fuente($row->nid,$br->tipos_fuente,$br->grupo_nid,$node_type,$in_tipos_fuente)){
                continue;
            }
        }
        $in_categorias=array();
        if(!boletin_report_in_categorias($row->nid,$br->categorias,$br->grupo_nid,$node_type,$in_categorias)){
            continue;
        }
        //
        $result[$kont]=$row;
        //AVISO::::misma estructura alerta_notif
        $result[$kont]->my_type='node';
        $result[$kont]->node_type=$node_type;
        $result[$kont]->my_action='';
        $result[$kont]->uid=$row->node_uid;
        $result[$kont]->cid=0;
        $result[$kont]->fecha=$row->node_changed;
        $result[$kont]->in_categorias=$in_categorias;
        if(red_despacho_is_activado()){
            $result[$kont]->in_tipos_fuente=$in_tipos_fuente;
        }
        $kont++;
    }
    return $result;
}
function boletin_report_is_report_access($node){
    if(isset($node->og_groups) && !empty($node->og_groups)){
        $values=array_values($node->og_groups);
        if(count($values)>0){
            $grupo_nid=$values[0];
            //if(boletin_report_is_permiso_editar($grupo_nid)){
            if(user_access('report content')){
                return 1;
            }
        }    
    }    
    return 0;
}
function boletin_report_link($node,$is_ajax=0){
    //intelsat-2015
    if(red_despacho_is_show_boletin_report_link()){
        if(isset($node->nid) && !empty($node->nid)){
            $row=boletin_report_get_node_row($node->nid);
            if(!empty($row) && isset($row->nid) && !empty($row->nid)){
                if(!empty($row->sended) && $row->sended==1){
                    //$params=array('query'=>drupal_get_destination(),'attributes'=>array('title'=>t('Sent'),'alt'=>t('Sent'),'id'=>'id_report_ajax_'.$node->nid,'class'=>'a_no_report_ajax'));
                    $params=array('query'=>drupal_get_destination(),'attributes'=>array('title'=>t('Select for the Bulletin'),'alt'=>t('Select for the Bulletin'),'id'=>'id_report_ajax_'.$node->nid,'class'=>'a_report_ajax'));                
                    if($is_ajax){
                        unset($params['query']);
                    }
                    $label='';
                    //return l('','boletin_report/'.$node->nid.'/no_report',$params);
                    return l('','boletin_report/'.$node->nid.'/report',$params);
                }else{
                    $params=array('query'=>drupal_get_destination(),'attributes'=>array('title'=>t('Unselect from Bulletin'),'alt'=>t('Unselect from Bulletin'),'id'=>'id_report_ajax_'.$node->nid,'class'=>'a_no_report_ajax'));
                    if($is_ajax){
                        unset($params['query']);
                    }
                    $label='';
                    return l('','boletin_report/'.$node->nid.'/no_report',$params);
                }    
            }else{
                //return l(t('Select for the Bulletin'),'boletin_report/'.$node->nid.'/report',array('query'=>drupal_get_destination()));
                $label='';
                //$label=t('Select for the Bulletin');
                $params=array('query'=>drupal_get_destination(),'attributes'=>array('title'=>t('Select for the Bulletin'),'alt'=>t('Select for the Bulletin'),'id'=>'id_report_ajax_'.$node->nid,'class'=>'a_report_ajax'));
                if($is_ajax){
                    unset($params['query']);
                }
                return l($label,'boletin_report/'.$node->nid.'/report',$params);
            }    
        }
    }    
    return '';
}
function boletin_report_get_node_row($nid){
    $result=boletin_report_get_node_row_list($nid);
    if(count($result)>0){
        return $result[0];
    }
    $row=new stdClass();
    return $row;
}
function boletin_report_get_node_row_list($nid=''){
    $result=array();
    $where=array();
    $where[]='1';
    $where[]='brn.nid='.$nid;
    $sql='SELECT brn.* FROM {boletin_report_node} brn WHERE '.implode(' AND ',$where);
    $res=db_query($sql);
    while($row=db_fetch_object($res)){
        $result[]=$row;
    }
    return $result;
}
function boletin_report_is_permiso_gestion($grupo_nid,$is_session=1,$uid_konp='',$es_solo_edit=0){
    return is_permiso_gestion_boletin_grupo($grupo_nid,$is_session,$uid_konp,$es_solo_edit);
}
function boletin_report_is_permiso_editar($nid){   
    //if(red_is_claves_activado()){
        return boletin_report_is_permiso_gestion($nid);
    /*}else{
        return boletin_report_is_permiso_gestion($nid,1,'',1);
    }*/
}
function boletin_report_yes_form(){
    
    $nid=arg(1);
    $node=node_load($nid);

    if(!boletin_report_is_report_access($node)){
        drupal_access_denied();
        exit();
    }
    
        $form['my_nid']=array(
            '#type'=>'hidden',
            '#default_value' =>$nid,
        );
    //
    /*$form['borrar_msg']=array(
        '#value'=>t('This action cannot be undone.').'<BR>',
    );*/

    $form['boletin_report_yes_btn_submit']=array(
  '#type' => 'submit',
  '#value' => t('Bulletin'),
);
    
  
$my_destination=$_REQUEST['destination'];
    

$form['boletin_report_yes_volver']=array(
  '#value' => l(t('Cancel'),$my_destination),  
$term_items
);

    return $form;
}
function boletin_report_yes_form_submit(&$form, &$form_state){
    $values=$form_state['values'];    
    if(isset($values['my_nid']) && !empty($values['my_nid']) && is_numeric($values['my_nid'])){
        $nid=$values['my_nid'];
        boletin_report_insert_yes($nid);
    }    
}
function boletin_report_insert_yes($nid){
    $row=boletin_report_get_node_row($nid);
    $sended=0;
    if(isset($row->nid) && !empty($row->nid)){
        boletin_report_delete_node_row($nid);
    }//else{
        $report_type=boletin_report_get_type_by_nid($nid);    
        db_query('INSERT INTO {boletin_report_node}(nid,report_type,sended) VALUES(%d,"%s",%d)',$nid,$report_type,$sended);        
    //}
}
function boletin_report_get_type_by_nid($nid){
    $node=node_load($nid);
    if(isset($node->nid) && !empty($node->nid)){
        return boletin_report_get_type_by_node_type($node->type);
    }
    return '';
}
function boletin_report_get_type_by_node_type($node_type){
    $report_type_array=boletin_report_define_type_array();
    if(isset($report_type_array[$node_type])){
        return $report_type_array[$node_type];
    }
    return '';
}
function boletin_report_define_type_array(){
    $result=array();
    $result['item']='item_report';
    $result['noticia']='noticia_report';
    $result['debate']='debate_report';
    $result['wiki']='wiki_report';
    $result['my_report']='node_report';
    return $result;
}
function boletin_report_no_form(){
    
    $nid=arg(1);
    $node=node_load($nid);

    if(!boletin_report_is_report_access($node)){
        drupal_access_denied();
        exit();
    }
    
        $form['my_nid']=array(
            '#type'=>'hidden',
            '#default_value' =>$nid,
        );
    //
    /*$form['borrar_msg']=array(
        '#value'=>t('This action cannot be undone.').'<BR>',
    );*/

    $form['boletin_report_no_btn_submit']=array(
  '#type' => 'submit',
  '#value' => t('No Bulletin'),
);
    
  
$my_destination=$_REQUEST['destination'];
    

$form['boletin_report_no_volver']=array(
  '#value' => l(t('Cancel'),$my_destination),  

);

    return $form;
}
function boletin_report_no_form_submit(&$form, &$form_state){
    $values=$form_state['values'];    
    if(isset($values['my_nid']) && !empty($values['my_nid']) && is_numeric($values['my_nid'])){
        $nid=$values['my_nid'];
        boletin_report_delete_node_row($nid);
    }    
}
function boletin_report_delete_node_row($nid){
    db_query('DELETE FROM {boletin_report_node} WHERE nid='.$nid);            
}
function boletin_report_view_list(){
  drupal_set_title(t('Reports Area'));  
  //AVISO::::node_page_default
  $my_limit=variable_get('default_nodes_main', 10);
//$my_limit=2;
  $where=array();
  $where[]='1';
  $where[]='n.type="my_report"'; 
  //$where[]='n.promote = 1'; 
  $where[]='n.status = 1';
  $my_grupo=og_get_group_context();
  if(isset($my_grupo->nid) && !empty($my_grupo->nid)){     
      $where[]='og_ancestry.group_nid='.$my_grupo->nid;
  }
  //
  $sql='SELECT n.nid, n.sticky, n.created 
  FROM 
  {node} n 
  LEFT JOIN {og_ancestry} og_ancestry ON n.nid=og_ancestry.nid 
  WHERE '.implode(' AND ',$where).' ORDER BY n.created DESC';
  $result = pager_query(db_rewrite_sql($sql), $my_limit);

  $output = '';
  $num_rows = FALSE;
  while ($node = db_fetch_object($result)) {
    $output .= node_view(node_load($node->nid), 1);
    $num_rows = TRUE;
  }
  
  if ($num_rows) {
    //$feed_url = url('rss.xml', array('absolute' => TRUE));
    //drupal_add_feed($feed_url, variable_get('site_name', 'Drupal') . ' ' . t('RSS'));
    $output .= theme('pager', NULL,$my_limit);
  }
  else {
     $output.= '<div id="first-time">' .t('There are no contents'). '</div>';  
  }
  //$output=boletin_report_create_menu_node_list().$output;
  return $output;
}
function boletin_report_hay_novedades($hay_todos_items,$hay_todos_noticias_usuario,$hay_todos_reports,$hay_todos_debates,$hay_todos_wikis,$bulletin_text_content,$bulletin_text_nid,$br=''){    
    //intelsat-2016
    if(boletin_report_inc_hay_novedades_boletin_report_automatico($br)){
        return 1;
    }
    if($bulletin_text_nid){
        if(!empty($bulletin_text_content)){
            return 1;
        }
    }else{
        if($hay_todos_items || $hay_todos_noticias_usuario || $hay_todos_reports || $hay_todos_debates || $hay_todos_wikis){
            return 1;
        }
    }
    return 0;
}
function boletin_report_launch_form(){
    drupal_set_title(t('Launch Bulletin'));
    $form=array();
    
    boletin_report_no_group_selected_denied(); 
    
    $id=arg(1);
    $row=boletin_report_get_row($id);
    $grupo_nid='';
    if(isset($row->grupo_nid) && !empty($row->grupo_nid)){
        $grupo_nid=$row->grupo_nid;
    }
    boletin_report_my_access($grupo_nid);
        
    if(!boletin_report_is_permiso_editar($row->grupo_nid)){
        drupal_access_denied();
        exit();
    }
        
        $form['my_id']=array(
            '#type'=>'hidden',
            '#default_value' =>$id,
        );
    //
    /*$form['borrar_msg']=array(
        '#value'=>t('This action cannot be undone.').'<BR>',
    );*/

    $form['boletin_report_launch_btn_submit']=array(
  '#type' => 'submit',
  '#value' => t('Launch Bulletin'),
);
    
  
$my_destination=$_REQUEST['destination'];
    

$form['boletin_report_launch_volver']=array(
  '#value' => l(t('Cancel'),$my_destination),  

);

    return $form;
}
function boletin_report_launch_form_submit($form, &$form_state){
    global $base_url;
    $values=$form_state['values'];    
    if(isset($values['my_id']) && !empty($values['my_id']) && is_numeric($values['my_id'])){
        $r=boletin_report_get_row($values['my_id']);
        $nid=0;
        $text_row='';
        if(boletin_report_hay_report_text_sin_enviar($r)){
            $text_row=boletin_report_get_edit_text_row($r->boletin_report_array_id);
            $nid=$text_row->nid;
        }
            $id=$values['my_id'];
            $dia=date('N');
            $nombre_dia=get_nombre_dia($dia);
            $br_list=boletin_report_get_list($id);            
            if(count($br_list)>0){
                $br=$br_list[0];
                $por_correo=1;
                $content=boletin_report_exec($br,$nombre_dia,$por_correo,$nid,$text_row);    
            }
             
    }    
}
function boletin_report_define_table_headers($is_mis_alertas=1,$is_alerta_publico=0){
    $headers=array();
    $headers[0]=array('data'=>t('Serie'),'field'=>'titulo');
    $headers[1]=array('data'=>t('Group'),'field'=>'title');
    $headers[2]=array('data'=>t('Method'),'field'=>'send_method');
    $headers[3]=array('data'=>t('Creation date'),'field'=>'created');
    //intelsat-2015
    //$headers[4]=array('data'=>t('Date'),'field'=>'fecha');
    $headers[4]=array('data'=>t('Last Edition'),'field'=>'fecha');    
    $headers[5]=t('Edition');
    $headers[6]=t('Archive');
    //
    $headers[7]=t('Actions');
    if($is_alerta_publico){
          unset($headers[6]);
          $headers[6]=$headers[7];
          unset($headers[7]);
          if(hontza_is_user_anonimo()){
            unset($headers[5]);
          }
    }    
    //gemini-2014
    unset($headers[2]);
    unset($headers[3]);
    //intelsat-2015
    $my_grupo=og_get_group_context();
    if(isset($my_grupo->nid) && !empty($my_grupo->nid)){
         unset($headers[1]);
    }
    //
    $headers=array_values($headers);
    //intelsat-2015
    if($is_alerta_publico){
        $num=count($headers);
        $row=$headers[$num-1];
        $headers[$num-1]=t('Archive');
        $headers[]=$row;
    }
    //
    //intelsat-2015
    if(red_despacho_is_activado()){
        $headers=red_despacho_boletin_report_unset_headers($headers);
    }    
    return $headers;
}
function boletin_report_create_categorias_fieldset_txek($row,$grupo_nid){
    $result=array();
    $result=array(
    '#type'=>'fieldset',
    '#title'=>t('Categories'),
    '#collapsible'=>TRUE,
    '#attributes'=>array('id'=>'id_boletin_report_categories_fs'),    
);
    $tid_array=array();
    
    if(isset($row->categorias) && !empty($row->categorias)){
        $tid_array=$row->categorias;
    }
        
    $id_categoria = db_result(db_query("SELECT og.vid FROM {og_vocab} og WHERE  og.nid=%s", $grupo_nid));
     $categorias=taxonomy_get_tree($id_categoria);
            //echo print_r($categorias,1);$term_items
            if(!empty($categorias)){
                foreach ($categorias as $id => $contenido) {
                     //if(boletin_report_is_parent_zero($contenido)){   
                        //$pro=0;
                        //intelsat-2015
                        $pro=profundidad($contenido->tid);
                        $key='my_cat_'.$contenido->tid;
                        //
                        $result[$key] = array(
                          '#required' => TRUE,
                          '#type' => 'checkbox',
                          '#prefix' => '<div class=taxo'. $pro .'>',
                          '#suffix' => '</div>',
                          '#title' => $contenido->name
                        );
                        if(in_array($contenido->tid,$tid_array)){
                           $result[$key]['#attributes']=array('checked' => 'checked');
                         }
                     //}   
                  }
            }
    
    //
    return $result;
}
function boletin_report_is_parent_zero($term){
    $result=0;
    if(isset($term->parents)){
        foreach($term->parents as $i=>$v){
            if(empty($v)){
                return 1;
            }
        }
    }else{
        return 1;
    }
    return $result;
}
function boletin_report_get_categorias_tid_array($id){
    $result=array();
    $sql='SELECT c.tid FROM {boletin_report_array_categorias} c WHERE boletin_report_array_id='.$id;
    $res=db_query($sql);
    while($row=db_fetch_object($res)){
        $result[]=$row->tid;
    }
    return $result;
}
function boletin_report_save_categorias($id,$categorias){
	boletin_report_delete_categorias($id);
	if(count($categorias)>0){
            foreach($categorias as $i=>$tid){
                boletin_report_insert_categorias($id,$tid);
            }            
	}       
}
function boletin_report_get_categorias_by_values($values){
    $result=array();
    $konp='my_cat_';
    if(!empty($values)){
        foreach($values as $name=>$v){
            $pos=strpos($name,$konp);
            if($pos===false){
                //
            }else{
                if(!empty($v)){
                    $tid=trim(str_replace($konp,'',$name));                    
                    if(!empty($tid)){
                        $result[]=$tid;
                    }
                }
            }
        }
    }
    return $result;
}
function boletin_report_delete_categorias($id){
	$sql='DELETE FROM {boletin_report_array_categorias} WHERE boletin_report_array_id='.$id;
	db_query($sql);
}
function boletin_report_insert_categorias($id,$tid){
	$sql='INSERT {boletin_report_array_categorias}(boletin_report_array_id,tid) VALUES('.$id.','.$tid.')';
	db_query($sql);
}
function boletin_report_get_item_categorias($nid){
    $result=array();
    //intelsat-2014
    $item_tid_array=array();
    //    
    $node=node_load($nid);
    if($node->type=='item'){
        //intelsat-2014
        if(hontza_solr_is_solr_activado()){
            if(isset($node->field_item_canal_category_tid) && !empty($node->field_item_canal_category_tid)){
                foreach($node->field_item_canal_category_tid as $i=>$value_row){
                    $item_tid_array[]=$value_row['value'];
                }
            }
        }else{
            //
            if(isset($node->field_item_canal_reference) && isset($node->field_item_canal_reference[0]) && isset($node->field_item_canal_reference[0]['nid'])){
                $canal_nid=$node->field_item_canal_reference[0]['nid'];
                if(!empty($canal_nid)){
                    $canal=node_load($canal_nid);
                    if(isset($canal->taxonomy) && !empty($canal->taxonomy)){
                        $result=array_keys($canal->taxonomy);                
                    }
                }
            }
        }    
    }else{
        if(isset($node->taxonomy) && !empty($node->taxonomy)){
            $result=array_keys($node->taxonomy);            
        }
    }
    //intelsat-2014
    if(hontza_solr_is_solr_activado()){
        $result=array_merge($item_tid_array,$result);
        $result=array_unique($result);
    }
    //
    return $result;
}
function boletin_report_in_categorias($nid,$categorias,$grupo_nid,$node_type,&$in_categorias){
    $result=array();
    $sin_categoria=boletin_report_get_sin_categoria($nid);
    if(!empty($sin_categoria)){
        //intelsat-2015
        $in_categorias=$sin_categoria;
        if(!in_array($node_type,array('my_report'))){
            return 1;
        }    
    }
    $item_categorias=boletin_report_get_item_categorias($nid);
    //intelsat-2015
    //esto se implementó en la versión local de crear usuario net, si es necesario en los subdominios, lo descomentamos
    /*$item_categorias=boletin_report_set_categorias_tematicas($item_categorias,$nid);
    if(empty($item_categorias)){
      $indefinida_tid=my_get_term_data_tid('Categoria indefinida');
      if(!empty($indefinida_tid)){
	$item_categorias=array();
	$item_categorias[0]=$indefinida_tid;
      }
    }*/
    //
    if(!empty($categorias) && !empty($item_categorias)){
        foreach($categorias as $i=>$tid){            
                if(in_array($tid,$item_categorias)){
                    //return 1;
                    if(!in_array($tid,$result)){
                        $result[]=$tid;
                    }    
                }                
        }
        $id_categoria = db_result(db_query("SELECT og.vid FROM {og_vocab} og WHERE  og.nid=%s", $grupo_nid));
        foreach($categorias as $k=>$tid){
            $tree=taxonomy_get_tree($id_categoria,$tid);
            if(!empty($tree)){
                foreach($tree as $a=>$tree_row){
                    if(in_array($tree_row->tid,$item_categorias)){
                        //return 1;
                        if(!in_array($tid,$result)){
                            $result[]=$tid;
                        }
                    }
                }
            }
        }
    }
    //intelsat-2015
    if(empty($sin_categoria)){
        $in_categorias=$result;
    }
    //
    if(count($result)>0){
        return 1;
    }
    return 0;
}
function boletin_report_por_categorias($br,&$hay_todos_items,&$hay_todos_noticias_usuario,&$hay_todos_reports,&$my_message,&$sended_array,&$hay_todos_debates,&$hay_todos_wikis){
    $html=array();
    $hay_todos_items=0;
    $hay_todos_noticias_usuario=0;
    $hay_todos_reports=0;
    $hay_todos_debates=0;
    $hay_todos_wikis=0;
    $items=array();
    $noticias_usuario=array();
    $reports=array();
    $debates=array();
    $wikis=array();
    $sended_array=array(); 
    //
    
                if($br->is_todos_items){
                    $items=boletin_report_get_items($br);
                    $sended_array['items']=$items; 
                    $hay_novedades_out=0;
                    $items=boletin_report_prepare($items,'item_report',$hay_novedades_out,$br->limite_todos_items, '', '', '',$br->grupo_nid,$br->limite_resumen,$br);
                    if(count($items)>0){
                        $hay_todos_items=1;
                    }                    
                }
                //
                if($br->is_todos_noticias_usuario){
                    $noticias_usuario=boletin_report_get_items($br,'noticia','noticia_report');
                    $sended_array['noticias_usuario']=$noticias_usuario;
                    $hay_novedades_out=0;
                    $noticias_usuario=boletin_report_prepare($noticias_usuario,'noticia',$hay_novedades_out,$br->limite_todos_noticias_usuario, '', '', '',$br->grupo_nid,$br->limite_resumen,$br);
                    if(count($noticias_usuario)>0){
                        $hay_todos_noticias_usuario=1;
                    }                   
                }
                if($br->is_todos_reports){
                    $reports=boletin_report_get_items($br,'my_report','node_report');
                    $sended_array['reports']=$reports;
                    $hay_novedades_out=0;
                    $reports=boletin_report_prepare($reports,'node_report',$hay_novedades_out,$br->limite_todos_reports, '', '', '',$br->grupo_nid,$br->limite_resumen,$br);
                    if(count($reports)>0){
                        $hay_todos_reports=1;
                    }
                }                
                if($br->is_todos_debates){
                    $debates=boletin_report_get_items($br,'debate','debate_report');
                    $sended_array['debates']=$debates;
                    $hay_novedades_out=0;
                    $debates=boletin_report_prepare($debates,'debate_report',$hay_novedades_out,0, '', '', '',$br->grupo_nid,0,$br);
                    if(count($debates)>0){
                        $hay_todos_debates=1;
                    }
                }
                if($br->is_todos_wikis){
                    $wikis=boletin_report_get_items($br,'wiki','wiki_report');
                    $sended_array['wikis']=$wikis;
                    $hay_novedades_out=0;
                    $wikis=boletin_report_prepare($wikis,'wiki_report',$hay_novedades_out,0, '', '', '',$br->grupo_nid,0,$br);
                    if(count($wikis)>0){
                        $hay_todos_wikis=1;
                    }
                }
                     
     if(($hay_todos_items || $hay_todos_noticias_usuario || $hay_todos_reports || $hay_todos_debates || $hay_todos_wikis) && count($br->categorias)>0){
        //intelsat-2015         
        //$items=array_merge($items,$noticias_usuario,$reports,$debates,$wikis);        
        $items=boletin_report_inc_items_merge_orden($items,$noticias_usuario,$reports,$debates,$wikis,$br,$orden_values_array);
        $is_numeric=1;
        //intelsat-2015
        if(red_despacho_is_activado()){
            red_despacho_boletin_report_por_tipos_fuente($br,$html,$items);
        }else{
            //intelsat-2015
            $categorias=$br->categorias;
            $categorias=boletin_report_inc_add_categorias_titulo($categorias);
            //
            $categorias_orden=boletin_report_inc_get_categorias_orden($categorias,$orden_values_array);
            foreach($categorias_orden as $i=>$tid){
                $term_items=boletin_report_get_items_by_tid($items,$tid);
                $term_name=boletin_report_get_term_name($tid);
                //intelsat-2015
                if(in_array($tid,$br->categorias)){
                //    
                    $num=count($term_items);
                    if($num>0){
                        //echo print_r($term_items,1);exit();
                        if(in_array($tid,array('debate','wiki','my_report'))){
                            $term_items=array_ordenatu($term_items,'fecha','asc', $is_numeric);                
                        }else{
                            //print 'tid='.$tid.'<BR>';
                            $term_items=array_ordenatu($term_items,'votingapi_cache_node_average_value','desc', $is_numeric);                
                        }                                
                        $hay_novedades_out=0;
                        $content=create_boletin_mail_html($term_items,'categorias_report',$hay_novedades_out,$num, '', '', '',$br->grupo_nid,$br->limite_resumen,$br,$term_name);
                        if(!empty($content) && $hay_novedades_out){                        
                            $html[]=$content;                            
                        }    
                    }else{                
                        $html[]=no_hay_novedades_html('categorias_report', '',$my_message,'',$term_name);
                    }
                }else{
                    //intelsat-2015
                    if(boletin_report_inc_categorias_titulo_activado()){
                        $html[]=no_hay_novedades_html('categorias_report', '',$my_message,'',$term_name,1);
                    }
                }    
            }
        }    
     }else{
        return no_hay_novedades_html('categorias_report', '',$my_message,'',t('Categories'));
     }
     return implode('',$html);
}
function boletin_report_prepare($my_list_in,$current_type,&$hay_novedades_out,$my_limite_in='',$titulo_mail='',$param_alerta='',$tid_in='',$grupo_nid='',$limite_resumen_in=0,$bg=''){
    //gemini-2013
    $hay_novedades_out=0;
    $html=array();
    $my_list=anular_rows($my_list_in);
    $num_orig=count($my_list);
    $my_limite=get_alerta_my_limite($my_limite_in);
    //print 'aurretik='.count($my_list).'<BR>';
    $my_list=array_slice($my_list,0,$my_limite);
    return $my_list;    
}
//intelsat-2015
//function boletin_report_get_items_by_tid($items,$tid){
function boletin_report_get_items_by_tid($items,$tid,$field='in_categorias'){
    $result=array();
    if(count($items)>0){
        foreach($items as $i=>$row){
            //intelsat-2015
            //if(in_array($tid,$row->in_categorias)){
            if(in_array($tid,$row->$field)){
                $result[]=$row;
            }
        }
    }
    return $result;
}
function boletin_report_exist_email_externos($email_externos_in){
    $email_externos=trim($email_externos_in);
    if(!empty($email_externos)){
        return 1;
    }
    return 0;
}
function boletin_report_save_aviso_procesado($row,$por_correo,$my_message,$sended_array,$bulletin_text_nid=0,$text_row='',$content=''){
    //AVISO::::my_message empty significa que esta en hora y en frecuencia
    //simulando
    //$por_correo=1;
    global $user;
    $result_nid=$bulletin_text_nid;
    if(in_array($row->send_method,array('mail','mimemail')) && $por_correo && empty($my_message)){
        boletin_report_save_array_today($row,$fecha_sended,$boletin_report_array_today_id);
        if($bulletin_text_nid){
            boletin_report_update_sended_edit($bulletin_text_nid,$text_row,$fecha_sended,$boletin_report_array_today_id);
            $new_text_row=$text_row;
            //intelsat-2015
            $bulletin_text_node=node_load($bulletin_text_nid);
            boletin_report_inc_update_titulo_boletin($row->id,$bulletin_text_node->title);
        }else{
            $node=new stdClass();
            //intelsat-2015
            //$node->title=$row->titulo;
            $titulo_boletin=boletin_report_inc_get_title_of_bulletin_automatico('',0,$row);
            $node->title=$titulo_boletin;
            //
            $node->body=$content;        
            $node->boletin_report_array_id=$row->id;
            $node->uid=$user->uid;
            $node->type='bulletin_text';
            $node->status=1;
            node_save($node);
            $result_nid=$node->nid;
            $new_text_row=boletin_report_get_edit_text_row_by_nid($row->id,$node->nid);            
            boletin_report_update_sended_edit($node->nid,$new_text_row,$fecha_sended,$boletin_report_array_today_id);
            //intelsat-2015
            boletin_report_inc_update_titulo_boletin($row->id,$titulo_boletin);
        }
        boletin_report_update_sended_array($sended_array,1,$fecha_sended,$row,$boletin_report_array_today_id);
        if(boletin_report_is_save_noticia_boletines_sareko_id()){
            boletin_report_save_noticia_boletines($sended_array,$new_text_row,$fecha_sended,$row,$boletin_report_array_today_id);
        }
        //intelsat-2015
        if(red_solr_inc_is_status_activado()){
            red_solr_inc_update_node_seleccionado_boletin_array($sended_array);
        }  
    }
    return $result_nid;
}
function boletin_report_save_array_today($param,&$fecha,&$boletin_report_array_today_id){
    boletin_report_insert_array_today($param,$fecha,$boletin_report_array_today_id);   
}
function boletin_report_insert_array_today($param,&$fecha,&$boletin_report_array_today_id){
    global $user;
    $fecha='';
    $boletin_report_array_today_id=0;
    if($param->send_method=='mimemail'){
        //$fecha=date("Y-m-d")." 00:00:00";
        $fecha=date("Y-m-d H:i:s");
        $sql=sprintf("INSERT INTO boletin_report_array_today(boletin_report_array_id,send_method,fecha,execute_uid) VALUES(%d,'%s','%s',%d)",$param->id,$param->send_method,$fecha,$user->uid);
        db_query($sql);
        $boletin_report_array_today_id=db_last_insert_id('boletin_report_array_today','id');
    }
}
function boletin_report_update_sended_array($sended_array,$sended,$fecha_sended,$param,$boletin_report_array_today_id){
    global $user;
    if(!empty($sended_array)){
        foreach($sended_array as $item_type=>$item_array){
            if(!empty($item_array)){
                foreach($item_array as $i=>$row){
                    $fecha_sended=date("Y-m-d H:i:s");
                    db_query('UPDATE {boletin_report_node} SET sended=%d,uid_sended=%d,fecha_sended="%s",boletin_report_array_id=%d,boletin_report_array_today_id=%d WHERE nid=%d AND report_type="%s"',$sended,$user->uid,$fecha_sended,$param->id,$boletin_report_array_today_id,$row->nid,$row->report_type);                    
                }
            }
        }
    }
}
function boletin_report_get_date_of_last_bulletin($r){
    $my_array=boletin_get_report_array_today($r->boletin_report_array_id);
    if(count($my_array)>0){
        $r=$my_array[0];
        if(!empty($r->fecha)){
            //intelsat-2015
            //return $r->fecha;
            $result=strtotime($r->fecha);
            $result=date('Y-m-d',$result);
            return $result;
        }
    }    
    return '';
}
function boletin_get_report_array_today($boletin_report_array_id){
    $result=array();
    $sql='SELECT * FROM {boletin_report_array_today} WHERE boletin_report_array_id='.$boletin_report_array_id.' ORDER BY fecha DESC';
    $res=db_query($sql);
    while($row=db_fetch_object($res)){
        $result[]=$row;
    }
    return $result;
}
function boletin_report_add_update_ajax(){
    global $base_url;
    $purl='';
   $my_grupo=og_get_group_context(); 
   if(isset($my_grupo->purl) && !empty($my_grupo->purl)){
       $purl=$my_grupo->purl;
   }
    $js='$(document).ready(function()
   {
            create_call_report_ajax_functions();
            function call_report_ajax(nid){
             jQuery.ajax({
				//type: "POST",
                                type:"GET",
				url: "'.$base_url.'/'.$purl.'/boletin_report/"+nid+"/report_ajax?my_time="+new Date().getTime(),
				dataType:"json",
				success: function(my_result){
                                    set_report_item_ajax_on_success(my_result);
				}
			});
            }
            function call_no_report_ajax(nid){
             jQuery.ajax({
				//type: "POST",
                                type:"GET",
				url: "'.$base_url.'/'.$purl.'/boletin_report/"+nid+"/no_report_ajax?my_time="+new Date().getTime(),
				dataType:"json",
				success: function(my_result){
                                    set_report_item_ajax_on_success(my_result);                                    
				}
			});
            }
            function create_call_report_ajax_functions(){
                $("a.a_report_ajax").unbind( "click" );
                $("a.a_report_ajax").click(function(){
                    var a_id=$(this).attr("id");
                    var nid=a_id.replace("id_report_ajax_","");
                    call_report_ajax(nid);
                    return false;
                });
                $("a.a_no_report_ajax").unbind( "click" );
                $("a.a_no_report_ajax").click(function(){
                    var a_id=$(this).attr("id");
                    var nid=a_id.replace("id_report_ajax_","");
                    call_no_report_ajax(nid);
                    return false;
                });
            }
            function set_report_item_ajax_on_success(my_result){
                var my_parent=$("#id_report_ajax_"+my_result.nid).parent();
                var my_class=my_parent.attr("class");
                my_parent.attr("class",set_report_item_class_ajax(my_class));
                my_parent.html(my_result.a);
                create_call_report_ajax_functions();
            }
            function set_report_item_class_ajax(my_class){
                /*if(my_class=="n-item-report"){
                    return "n-item-no-report";
                }
                if(my_class=="n-item-no-report" || my_class=="n-item-sent"){
                    return "n-item-report";
                }
                if(my_class=="item-report"){
                    return "item-no-report";
                }
                if(my_class=="item-no-report" || my_class=="item-sent"){
                    return "item-report";
                }*/
                if(my_class=="n-item-report" || my_class=="n-item-sent"){
                    return "n-item-no-report";
                }
                if(my_class=="n-item-no-report"){
                    return "n-item-report";
                }
                if(my_class=="item-report" || my_class=="item-sent"){
                    return "item-no-report";
                }
                if(my_class=="item-no-report"){
                    return "item-report";
                }    
            }
   });';
   drupal_add_js($js,'inline');
}
function boletin_report_ajax_callback(){
    $result=array();
    $nid=arg(1);
    boletin_report_insert_yes($nid);
    $result['nid']=$nid;
    $node=node_load($nid);
    //gemini-2014
    hontza_validar_con_accion($nid);
    //intelsat-2015
    red_solr_inc_update_node_seleccionado_boletin($node);
    $result['a']=boletin_report_link($node,1);
    print json_encode($result);
    exit();
}
function boletin_report_no_ajax_callback(){
    $result=array();
    $nid=arg(1);
    boletin_report_delete_node_row($nid);
    $node=node_load($nid);    
    //intelsat-2015
    red_solr_inc_update_node_seleccionado_boletin($node);        
    $result['nid']=$nid;
    $result['a']=boletin_report_link($node,1);
    print json_encode($result);
    exit();
}
function boletin_report_action_class($node,$is_n=1){
    $result='item-report';
    if(isset($node->nid) && !empty($node->nid)){
        $row=boletin_report_get_node_row($node->nid);
        if(!empty($row) && isset($row->nid) && !empty($row->nid)){
            if(!empty($row->sended) && $row->sended==1){
                //$result='item-sent';
                $result='item-report';
            }else{
                $result='item-no-report';
            }    
        }else{
            $result='item-report';
        }    
    }
    if($is_n){
        $result='n-'.$result;
    }
    return $result;
}
function boletin_report_is_permiso_editar_og_grupo(){
    $my_grupo=og_get_group_context();
    if(isset($my_grupo->nid) && !empty($my_grupo->nid)){
        return boletin_report_is_permiso_editar($my_grupo->nid);
    }
    return 0;
}
function boletin_report_is_permiso_editar_og_grupo_access(){
    if(!boletin_report_is_permiso_editar_og_grupo()){
        drupal_access_denied();
        exit();
    }
}
function boletin_report_node_delete_confirm_form_alter(&$form,&$form_state,$form_id){
    $form['#redirect']='boletin_report/report_view_list';
}
function boletin_report_is_editable_by_row($row,$default_value=0){
    $is_activado=$default_value;
    if(isset($row->id) && !empty($row->id)){
        $is_editable=0;
        if(isset($row->is_editable) && !empty($row->is_editable)){
            $is_editable=$row->is_editable;
        }
    }
    return $is_editable;
}
function boletin_report_define_url_edit_text($r,$purl=''){
    global $base_url;
    if(boletin_report_is_editable_by_row($r)){
        if(boletin_report_hay_report_text_sin_enviar($r)){
            $nid=boletin_report_get_editable_nid($r);
            //return 'node/'.$nid.'/edit';
            return $base_url.'/'.$purl.'/node/'.$nid.'/edit';
        }
    }
    return 'node/add/bulletin-text/'.$r->id;
}
function boletin_report_hay_report_text_sin_enviar($r){
    $result=boletin_report_get_edit_text_array($r->boletin_report_array_id);
    if(count($result)>0){
        return 1;
    }
    return 0;
}
function boletin_report_get_edit_text_array($boletin_report_array_id='',$id='',$with_edit=1){
    $result=array();
    if(!empty($boletin_report_array_id)){
        $where[]='boletin_report_array_id='.$boletin_report_array_id;
    }
    if(!empty($id)){
        $where[]='id='.$id;
    }
    $where[]='is_sended=0';
    /*if($with_edit){
        $where[]='is_edit=1';
    }else{
        $where[]='is_edit=0';
    }*/
    $where[]='is_edit=1';
    //
    $res=db_query('SELECT * FROM {boletin_report_array_edit} WHERE '.implode(' AND ',$where).' ORDER BY id DESC');
    while($row=db_fetch_object($res)){
        $result[]=$row;
    }
    return $result;
}
function boletin_report_get_editable_nid($r){
    $row=boletin_report_get_edit_text_row($r->boletin_report_array_id);
    if(isset($row->nid) && !empty($row->nid)){
        return $row->nid;
    }
    return 0;
}
function boletin_report_bulletin_text_node_form_alter(&$form,&$form_state,$form_id){
    $nid=hontza_get_nid_by_form($form);
    //    
    red_despacho_boletin_report_access_denied();    
    //intelsat-2015
    $form['title_of_series']=array(
        '#type'=>'textfield',
        '#title'=>t('Serie'),
        '#weight' =>-1000,
        '#attributes'=>array('readonly'=>'readonly')        
    );
    $form['title']['#title']=t('Bulletin');
    //
    //intelsat-2015
    $form['body_field']['body']['#title']=t('Body');            
    if(is_node_add('bulletin-text')){
        //intelsat-2015
        drupal_set_title(t('Create Bulletin Text'));
        $boletin_report_array_id=arg(3);
        $row=boletin_report_get_row($boletin_report_array_id);
        if(isset($row->id) && !empty($row->id)){
            //intelsat-2015
            //$form['title']['#default_value']=$row->titulo;
            $title_of_bulletin=boletin_report_inc_get_title_of_bulletin_automatico($boletin_report_array_id,0);
            $form['title']['#default_value']=$title_of_bulletin;
            //
            $form['title_of_series']['#default_value']=$row->titulo;
            $form['body_field']['body']['#default_value']=boletin_report_get_content($boletin_report_array_id);
            $form['boletin_report_array_id']=array(
                '#type'=>'hidden',
                '#default_value'=>$boletin_report_array_id,
            );
            $form['boletin_report_array_is_edit']=array(
                '#type'=>'hidden',
                '#default_value'=>1,
            );           
        }    
    }else{
        //intelsat-2015
        /*$boletin_report_array_edit_row=boletin_report_get_edit_text_array_by_nid('',$nid);
        echo print_r($boletin_report_array_edit_row,1);exit();
        $row=boletin_report_get_row($boletin_report_array_edit_row->boletin_report_array_id);
        echo print_r($row,1);
        exit();*/
        //
        $form['title_of_series']['#default_value']=boletin_report_inc_get_title_of_series($nid);
        $form['buttons']['reload_btn']=array(
            '#name'=>'reload_btn',
            '#type'=>'button',
            '#default_value'=>t('Reload'),
            '#weight' => 1000,
        );        
        boletin_report_add_reload_btn_js($nid);
    }
    
        $form['buttons']['volver_btn']=array(
            '#value'=>l(t('Cancel'),'boletin_report/list'),
            '#weight' => 1001,
        );
        boletin_report_unset_buttons(array('preview'),$form);
    
            if(!user_access('root')){
                $form['body_field']['format']['#prefix']='<div style="display:none;">';
                $form['body_field']['format']['#suffix']='</div>';
                $form['revision_information']['#prefix']='<div style="display:none;">';
                $form['revision_information']['#suffix']='</div>';
                $form['comment_settings']['#prefix']='<div style="display:none;">';
                $form['comment_settings']['#suffix']='</div>';
                $form['author']['#prefix']='<div style="display:none;">';
                $form['author']['#suffix']='</div>';
                $form['options']['#prefix']='<div style="display:none;">';
                $form['options']['#suffix']='</div>';
            }
}
function boletin_report_get_content($id,$bulletin_text_nid='',$text_row='',$is_edit_content=0){
    global $base_url;
    $content='';
    $dia=date('N');
    $nombre_dia=get_nombre_dia($dia);
    $br_list=boletin_report_get_list($id);
    if(count($br_list)>0){
        $br=$br_list[0];
        $por_correo=0;
        $content=boletin_report_exec($br,$nombre_dia,$por_correo,$bulletin_text_nid,$text_row,$is_edit_content);
        $content=str_replace('src="'.$base_url.'/'.$base_url,'src="'.$base_url,$content);
    }
    return $content;
}
function boletin_report_insert_bulletin_text_node($node){
    $is_edit=0;
    if(isset($node->boletin_report_array_is_edit) && !empty($node->boletin_report_array_is_edit)){
        $is_edit=1;
    }
    db_query('INSERT INTO {boletin_report_array_edit}(nid,vid,boletin_report_array_id,is_edit) VALUES(%d,%d,%d,%d)',$node->nid,$node->vid,$node->boletin_report_array_id,$is_edit);    
}
function boletin_report_get_edit_text_row($boletin_report_array_id='',$id='',$with_edit=1){
    $result=boletin_report_get_edit_text_array($boletin_report_array_id,$id,$with_edit);
    if(count($result)>0){
        return $result[0];
    }
    //
    $row=new stdClass();
    return $row;
}
function boletin_report_get_text_content($bulletin_text_nid){
    $node=node_load($bulletin_text_nid);
    if(isset($node->nid) && !empty($node->nid)){
        return $node->body;
    }
    return '';
}
function boletin_report_update_sended_edit($bulletin_text_nid,$text_row,$fecha_sended,$boletin_report_array_today_id){
    db_query('UPDATE {boletin_report_array_edit} SET is_sended=1,fecha_sended="%s",boletin_report_array_today_id=%d WHERE id=%d',$fecha_sended,$boletin_report_array_today_id,$text_row->id);
}
function boletin_report_historico_callback(){
    //$title=t('Sent Bulletins');
    //intelsat-2015
    $boletin_report_array_id=arg(1);
    $row=boletin_report_get_row($boletin_report_array_id);
    if(isset($row->id) && !empty($row->id)){
        $title_of_series=$row->titulo;
    }
    //
    $title=t('Archive of Series').': '.$title_of_series;
    drupal_set_title($title);
    boletin_report_no_group_selected_denied();
    $output=create_menu_alerta_user();
    $output.=boletin_report_historico_table();
    
    return $output;
}
function boletin_report_historico_table(){
    $my_limit=20;
    //intelsat-2015
    $is_alerta_publico=hontza_canal_rss_is_alerta_publico();
    $headers=boletin_report_define_historico_table_headers();
    $rows=array();
    $kont=0;
    $boletin_report_array_id=arg(1);
    //intelsat-2016
    $is_empty=1;
    if(!empty($boletin_report_array_id) && is_numeric($boletin_report_array_id)){
        $is_empty=0;
    }
    //
    $order_by=' ORDER BY e.fecha_sended DESC';
    $where=array();
    $where[]='1';
    $where[]='e.boletin_report_array_id='.$boletin_report_array_id;
    $where[]='e.fecha_sended!="0000-00-00 00:00:00"';
    $sql='SELECT * FROM {boletin_report_array_edit} e WHERE '.implode(' AND ',$where).$order_by;
    if(!$is_empty){
        $res=db_query($sql);
    }
    //intelsat-2015
    $is_alerta_publico=hontza_canal_rss_is_alerta_publico();
    //intelsat-2016
    if(!$is_empty){      
        while ($r = db_fetch_object($res)) {
          $node=node_load($r->nid);
          //$row=array();
          $rows[$kont][0]=$node->title;
          //$rows[$kont][1]=boletin_report_set_sending_value_string($r->is_sended);
          //intelsat-2015
          //$rows[$kont][1]=$r->fecha_sended;
          $fecha_sended=strtotime($r->fecha_sended);
          $fecha_sended=date('Y-m-d',$fecha_sended);
          $rows[$kont][1]=$fecha_sended;
          //intelsat-2015
          //$rows[$kont][2]=boletin_report_set_edition_type_value_string($r->is_edit,1);
          $rows[$kont][2]=red_despacho_boletin_report_set_edition_type_value_string($r->is_edit,1);
          $rows[$kont][3]=boletin_report_get_acciones_historico($r);
          //$row[$kont]=$row;
          //intelsat-2015
          if(($is_alerta_publico && hontza_is_user_anonimo()) || red_despacho_is_activado()){
              $my_row=$rows[$kont][3];
              unset($rows[$kont][3]);
              $rows[$kont][2]=$my_row;
          }
          $kont++;
        }
    }    

    /*if($is_date_of_last_bulletin){
        $rows=array_ordenatu($rows,'date_of_last_bulletin',strtolower($sort),1);
    }
    $rows=hontza_unset_array($rows,array('date_of_last_bulletin'));*/        
    $rows=my_set_estrategia_pager($rows, $my_limit);

  if (count($rows)>0) {
    /*$feed_url = url('idea_rss.xml', array('absolute' => TRUE));
    drupal_add_feed($feed_url, variable_get('site_name', 'Drupal') . ' ' . t('RSS'));*/
    $output .= theme('table',$headers,$rows);
    $output .= theme('pager', NULL, $my_limit);
  }
  else {

    $output.= '<div id="first-time">' .t('There are no contents'). '</div>';
  }
  //intelsat-2015
  $icono=my_get_icono_action('back_cancel',t('Back')).'&nbsp;';
  $url_cancel='boletin_report/list';
  if($is_alerta_publico){
      if(hontza_is_user_anonimo()){
          $url_cancel='publico/alerta_user/mis_boletines_grupo';
      }
  }
  $output.=l($icono.t('Back'),$url_cancel,array('html'=>TRUE));
  //
  return $output;
}
function boletin_report_define_historico_table_headers(){
    $headers=array();
    $headers[0]=array('data'=>t('Bulletin'),'field'=>'title');
    //$headers[1]=array('data'=>t('Sending'),'field'=>'is_sended');
    $headers[1]=array('data'=>t('Date'),'field'=>'fecha_sended');
    $headers[2]=array('data'=>t('Edition'),'field'=>'is_edit');
    $headers[3]=t('Actions');
    //intelsat-2015
    $is_alerta_publico=hontza_canal_rss_is_alerta_publico();
    if(($is_alerta_publico && hontza_is_user_anonimo()) || red_despacho_is_activado()){
        $my_row=$headers[3];
        unset($headers[3]);
        $headers[2]=$my_row;
    }
    return $headers;
}
function boletin_report_get_acciones_historico($r,$destination_in='',$only_view=0){
    $html=array();
    $id=arg(1);
    if(!empty($destination_in)){
        $destination=$destination_in;
    }else{    
        $destination='destination=boletin_report/'.$id.'/historico';
    }
    //intelsat-2015
    $is_alerta_publico=hontza_canal_rss_is_alerta_publico();
    $url_my_web='boletin_report/'.$r->boletin_report_array_id.'/my_web/'.$r->id;
    $url_download_html='boletin_report/'.$r->boletin_report_array_id.'/download_html/'.$r->id;
    $url_forward_bulletin='boletin_report/'.$r->boletin_report_array_id.'/forward/'.$r->id;
    if($is_alerta_publico){
        if(hontza_is_user_anonimo()){
            $url_my_web='publico_boletin_report/'.$r->boletin_report_array_id.'/previsualizacion_boletin/'.$r->id;
            //$url_download_html='publico_'.$url_download_html;
            $url_download_html='publico_boletin_report/'.$r->boletin_report_array_id.'/download_html_validate_email/'.$r->id;
            $url_forward_bulletin='publico_boletin_report/'.$r->boletin_report_array_id.'/forward_validate_email/'.$r->id;
        }    
    }
    $html[]=l(my_get_icono_action('viewmag', t('Web')),$url_my_web,array('query'=>$destination,'attributes'=>array('target'=>'_blank','title'=>t('Web'),'alt'=>t('Web')),'html'=>true));        
    if(!$only_view){
        $html[]=l(my_get_icono_action('download_manager', t('Download html')),$url_download_html,array('query'=>$destination,'attributes'=>array('target'=>'_blank','title'=>t('Download html'),'alt'=>t('Download html')),'html'=>true));        
        //intelsat-2015
        $attributes=red_despacho_boletin_report_get_forward_attributes();
        $html[]=l(my_get_icono_action('forward', t('Forward Bulletin')),$url_forward_bulletin,array('query'=>$destination,'attributes'=>$attributes,'html'=>true));            
    }
    if(is_super_admin()){
        $html[]=l(my_get_icono_action('pdf',t('Pdf')),'boletin_report/'.$r->boletin_report_array_id.'/pdf/'.$r->id,array('query'=>$destination,'attributes'=>array('target'=>'_blank','title'=>t('Pdf'),'alt'=>t('Pdf')),'html'=>true));        
    }
    //return add_div_actions(implode('&nbsp;',$html));
    return implode('&nbsp;',$html);
}
function boletin_report_on_bulletin_text_save($op,$node){
  if($node->type=='bulletin_text'){
      if($op=='insert'){
        boletin_report_insert_bulletin_text_node($node);
      }      
  } 
}
function boletin_report_get_edit_text_row_by_id($boletin_report_array_edit_id){
    $result=boletin_report_get_edit_text_array_by_id($boletin_report_array_edit_id);
    if(count($result)>0){
        return $result[0];
    }
    $row=new stdClass();
    return $Row;
}
function boletin_report_get_edit_text_array_by_id($id){
    $result=array();
    $where[]='1';
    if(!empty($id)){
        $where[]='id='.$id;
    }
    //
    $res=db_query('SELECT * FROM {boletin_report_array_edit} WHERE '.implode(' AND ',$where).' ORDER BY id DESC');
    while($row=db_fetch_object($res)){
        $result[]=$row;
    }
    return $result;
}
function boletin_report_get_edit_text_row_by_nid($boletin_report_array_id,$nid){
    $result=boletin_report_get_edit_text_array_by_nid($boletin_report_array_id,$nid);
    if(count($result)>0){
        return $result[0];
    }
    $row=new stdClass();
    return $row;
}
function boletin_report_get_edit_text_array_by_nid($boletin_report_array_id,$nid){
    $result=array();
    $where[]='1';
    if(!empty($boletin_report_array_id)){
        $where[]='boletin_report_array_id='.$boletin_report_array_id;
    }
    if(!empty($nid)){
        $where[]='nid='.$nid;
    }
    $res=db_query('SELECT * FROM {boletin_report_array_edit} WHERE '.implode(' AND ',$where).' ORDER BY id DESC');
    while($row=db_fetch_object($res)){
        $result[]=$row;
    }
    return $result;
}
function boletin_report_my_report_node_form_alter(&$form,&$form_state,$form_id){
    if($form_id=='my_report_node_form'){        
        $nid=hontza_get_nid_by_form($form);
        //intelsat-2015
        $modo_estrategia=1;
        if(!is_administrador_grupo($modo_estrategia)){
            drupal_access_denied();
            exit();
        }
        //
        if(empty($nid)){
            //intelsat-2015
            //se ha comentado esto, ahora se mira antes del if con is_administrador_grupo
            //boletin_report_is_permiso_editar_og_grupo_access();
            drupal_set_title(t('Create Report'));
        }/*else{
            //intelsat-2015
            $modo_estrategia=1;
            if(!is_administrador_grupo($modo_estrategia)){
                drupal_access_denied();
                exit();
            }
        }*/
        if(isset($form['title'])){
            $form['title']['#title']=t('Title');
        }
        if(isset($form['body_field']['body'])){
            $form['body_field']['body']['#title']=t('Body');
        }    
        $form['my_cat_']=create_categorias_tematicas_fieldset('',1,$nid,'my_report');
    }
}
function boletin_report_set_categorias($br){
    $result=array();
    if(isset($br->categorias) && !empty($br->categorias)){
        $result=$br->categorias;
    }
    if(!empty($br->is_todos_debates)){
        $result[]='debate';
    }
    if(!empty($br->is_todos_wikis)){
        $result[]='wiki';
    }
    if(!empty($br->is_todos_reports)){
        $result[]='my_report';
    }
    return $result;
}
//intelsat-2015
function boletin_report_set_categorias_tematicas($item_categorias,$nid){
    $node=node_load($nid);
    if(isset($node->nid) && !empty($node->nid)){
      $grupo_nid='';
      if(isset($node->og_groups) && !empty($node->og_groups)){
	$grupo_nid_array=array_values($node->og_groups);
	$grupo_nid=$grupo_nid_array[0];
      }
      if(!empty($grupo_nid)){
	$result=array();
	$id_categoria = db_result(db_query("SELECT og.vid FROM {og_vocab} og WHERE  og.nid = '%s'",$grupo_nid));
	if(!empty($item_categorias)){	
	  foreach($item_categorias as $i=>$tid){
	    $term = taxonomy_get_term($tid);
	    if(isset($term->vid) && $term->vid==$id_categoria){
		$result[]=$tid;
	    }
	  }
	}
	return $result;
      }      
    }
    return $item_categorias;
}